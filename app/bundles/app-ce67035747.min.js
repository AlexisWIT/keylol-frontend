!function(){"use strict";var e=angular.module("KeylolApp",["ngRoute","ngAnimate","angularMoment","ngStorage","ngFileUpload","ab-base64","angulartics"]);e.config(["$routeProvider","$locationProvider","utilsProvider","pageTitleProvider","$localStorageProvider","$httpProvider","$compileProvider","$analyticsProvider",function(e,t,n,o,i,r,a,c){t.html5Mode(!0),e.when("/home",{templateUrl:"components/pages/home.html",controller:"HomeController"}).when("/",{templateUrl:"components/pages/alpha-entrance.html",controller:"AlphaEntranceController"}).when("/article/:author/:article",{templateUrl:"components/pages/article.html",controller:"ArticleController"}).when("/point/:pointIdCode",{templateUrl:"components/pages/point.html",controller:"PointController"}).when("/user/:userIdCode",{templateUrl:"components/pages/point.html",controller:"PointController"}).when("/user/:userIdCode/publications",{templateUrl:"components/pages/point.html",controller:"PointController"}).when("/subscriptions",{templateUrl:"components/pages/search-results.html",controller:"SubscriptionsController"}).when("/readers",{templateUrl:"components/pages/search-results.html",controller:"ReadersController"}).when("/post",{templateUrl:"components/pages/post.html",controller:"PostController"}).when("/comments",{templateUrl:"components/pages/comments.html",controller:"CommentsController"}).when("/acknowledgements",{templateUrl:"components/pages/acknowledgements.html",controller:"AcknowledgementsController"}).when("/search/:searchType/:keyword",{templateUrl:"components/pages/search-results.html",controller:"SearchResultsController"}).when("/related/:idCode/:type",{templateUrl:"components/pages/search-results.html",controller:"RelatedController"}).otherwise({templateUrl:"components/pages/not-found.html",controller:"NotFoundController"}),o.setLoadingTitle("载入中 - 其乐"),n.config({geetestId:"accdaf35b04e4ad5bf4980c7d30edf87"}),i.setKeyPrefix("keylol-"),r.defaults.withCredentials=!0,a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|steam):/),window._czc=[],_czc.push(["_setAutoPageview",!1]),c.registerPageTrack(function(e){_czc.push(["_trackPageview",e])}),c.registerEventTrack(function(e,t){_czc.push(["_trackEvent",t.category||"未分类",e,t.label,t.value,t.nodeid])})}]),e.constant("amTimeAgoConfig",{fullDateThreshold:1,fullDateFormat:"YYYY-MM-DD HH:mm",titleFormat:"YYYY-MM-DD HH:mm:ss"}),e.constant("angularMomentConfig",{timezone:"+0800"}),window.keylolApp=e}(),function(){"use strict";keylolApp.config(["apiEndpointProvider",function(e){e.setEndPoint("https://gay-api.keylol.com/")}]),window.apiEndpoint="https://gay-api.keylol.com/"}(),function(){"use strict";keylolApp.controller("RootController",["$scope","pageTitle","union","$http","apiEndpoint","notification","$location","$rootScope",function(e,t,n,o,i,r,a,c){function l(){o.get(i+"user/"+n.$localStorage.login.UserId,{params:{includeClaims:!0,includeStats:!0,includeSubscribeCount:!0,includeCommentLike:!0}}).then(function(e){n.$localStorage.user=e.data,_czc.push(["_setCustomVar","登录用户",e.data.IdCode+"-"+e.data.UserName,1])},function(e){500!==e.status&&-1!==e.status&&(o["delete"](i+"login/current"),delete n.$localStorage.login,r.error("登录失效，请重新登录。"))})}t.loading(),e.$watch(function(){return n.$localStorage.login},function(e){if(e)l();else{_czc.push(["_setCustomVar","登录用户","游客",1]);for(var t in n.$localStorage)n.$localStorage.hasOwnProperty(t)&&0!==t.indexOf("$")&&delete n.$localStorage[t];for(var o in n.$sessionStorage)n.$sessionStorage.hasOwnProperty(o)&&0!==o.indexOf("$")&&delete n.$sessionStorage[o];a.url("/")}});var s=!0;c.$on("$routeChangeSuccess",function(){return window.scrollTo(0,0),s?void(s=!1):void(n.$localStorage.login&&l())})}])}(),function(){"use strict";keylolApp.directive("a",function(){return{restrict:"E",link:function(e,t,n){n.$observe("href",function(){var e=t[0];0!==e.protocol.indexOf("http:")&&0!==e.protocol.indexOf("https:")||0===location.host.indexOf(e.hostname)||(e.target="_blank")})}}})}(),function(){"use strict";keylolApp.directive("articleImageSrc",["utils","$filter",function(e,t){return{restrict:"A",priority:98,link:function(n,o,i){i.$observe("articleImageSrc",function(n){var o=t("uriRelocate")(n,"article.image");/^(?:http:|https:)?\/\/(storage|steamcdn)\.keylol\.com\//i.test(o)?e.supportWebp.then(function(){i.$set("src",o+".webp")},function(){i.$set("src",o)}):i.$set("src",o)})}}}])}(),function(){"use strict";keylolApp.directive("bindHtmlCompile",["$compile",function(e){return{restrict:"A",link:function(t,n,o){t.$watch(function(){return t.$eval(o.bindHtmlCompile)},function(i){n.html(i&&i.toString());var r=t;o.bindHtmlScope&&(r=t.$eval(o.bindHtmlScope)),e(n.contents())(r)})}}}])}(),function(){"use strict";keylolApp.directive("captureClick",["$parse",function(e){return{restrict:"A",compile:function(t,n){var o=e(n.captureClick,null,!0);return function(e,t){t[0].addEventListener("click",function(t){e.$apply(function(){o(e,{$event:t})})},!0)}}}}])}(),function(){"use strict";keylolApp.directive("flashingFigure",[function(){return{restrict:"E",templateUrl:"components/directives/flashing-figure.html",scope:{stations:"=",current:"="}}}])}(),function(){"use strict";keylolApp.directive("focusMe",["$parse",function(e){return{link:function(t,n,o){t.$watch(o.focusMe,function(i){i===!0&&(n[0].focus(),e(o.focusMe).assign(t,!1))})}}}])}(),function(){"use strict";keylolApp.directive("inputCode",[function(){return{restrict:"E",templateUrl:"components/directives/input-code.html",scope:{length:"="},require:"ngModel",link:function(e,t,n,o){e.repeats=new Array(e.length),e.text={},e.focus={},e.keydown=function(t,n){8===n.keyCode?(e.text={},e.focus[0]=!0):37===n.keyCode?e.focus[t-1]=!0:39===n.keyCode&&(e.focus[t+1]=!0)},e.focusFirstIfEmpty=function(){for(var t=0;t<e.length;++t)if(e.text[t])return;e.focus[0]=!0},o.$render=function(){if(o.$viewValue)for(var t=0;t<e.length;t++)e.text[t]=o.$viewValue[t]};for(var i=0;i<e.length;++i)!function(t){e.$watch("text["+t+"]",function(n,i){for(var r="",a=0;a<e.length;a++)e.text[a]&&(r+=e.text[a][0]);o.$setViewValue(r),n&&(!i||n.length>=i.length)&&(e.focus[t+1]=!0)})}(i)}}}])}(),function(){"use strict";keylolApp.directive("inputPoint",["$window","union","$timeout","$http",function(e,t,n,o){return{restrict:"E",templateUrl:"components/directives/input-point.html",scope:{placeholder:"=",limit:"=",disabled:"=",type:"="},require:"ngModel",link:function(i,r,a,c){c.$render=function(){if(i.pointArray=[],c.$viewValue)for(var e=0;e<c.$viewValue.length;e++)i.pointArray.push(c.$viewValue[e])};var l=function(e){var t=!1;for(var n in i.pointArray)i.pointArray[n].Id===e.Id&&(t=!0);t||i.pointArray.length>=i.limit||i.pointArray.push(e),i.data="",c.$setViewValue(i.pointArray)};i.deleteSelectorPoint=function(e){i.pointArray.splice(e,1),c.$setViewValue(i.pointArray)};var s=function(e){i.$apply(function(){8==e.keyCode&&i.pointArray.length>0&&!i.data&&(i.pointArray.splice(-1,1),c.$setViewValue(i.pointArray))})};i.selectPoint=function(t){i.pointArray[t].selected=!0;var n=function(r){i.$apply(function(){i.pointArray[t].selected=!1,8==r.keyCode&&i.deleteSelectorPoint(t),e.removeEventListener("click",o,!0),e.removeEventListener("keydown",n,!0),r.stopPropagation(),r.preventDefault()})},o=function(r){i.$apply(function(){i.pointArray[t].selected=!1,e.removeEventListener("click",o,!0),e.removeEventListener("keydown",n,!0)})};e.addEventListener("click",o,!0),e.addEventListener("keydown",n,!0)};var u=r.find(".input");r.click(function(e){e.target===u[0]||$(e.target).is(r.find(".point-title"))||r.children("input").focus()}),u.focus(function(){e.addEventListener("keydown",s,!0),i.disWatchData=i.$watch("data",function(a){i.dataChangeTimeout&&n.cancel(i.dataChangeTimeout),i.dataChangeTimeout=n(function(){i.nowPopup&&i.nowPopup.then(function(e){e.closeNow()}),e.removeEventListener("keydown",t.keydownCallback,!0),a&&o.get(apiEndpoint+"normal-point/keyword/"+encodeURIComponent(a),{params:{type:i.type||"Unspecified"}}).then(function(e){var t=e.data.length?e.data:[];i.nowPopup=i.showSelector({templateUrl:"components/popup/point-selector.html",controller:"PointSelectorController",attachSide:"bottom",event:{type:"click",currentTarget:r},align:"left",offsetX:-8,inputs:{selected:0,pointArray:t}}),i.nowPopup.then(function(e){return e.close}).then(function(e){e&&l(e)})})},200)})}),u.blur(function(){i.dataChangeTimeout&&n.cancel(i.dataChangeTimeout),e.removeEventListener("keydown",s,!0),i.disWatchData()}),i.linkHover=function(e,t){i.pointArray[t].showPointCard({templateUrl:"components/popup/point-preview-card.html",controller:"PointPreviewCardController",event:e,attachSide:"bottom",align:"left",inputs:{idCode:i.pointArray[t].IdCode,type:"point"}})}}}}])}(),function(){"use strict";keylolApp.directive("pagination",["$location",function(e){return{restrict:"E",templateUrl:"components/directives/pagination.html",scope:{total:"=",current:"=",onPageChanged:"&",pageHref:"&"},link:function(t){t.$watchGroup(["current","total"],function(){if(t.newPage=t.current,t.hasLeftEllipsis=t.current>4,t.hasRightEllipsis=t.total-t.current>4,t.leftPages=[],t.hasLeftEllipsis)t.leftPages.push(t.current-1);else for(var e=1;e<t.current;e++)t.leftPages.push(e);if(t.rightPages=[],t.hasRightEllipsis)t.rightPages.push(t.current+1),t.rightPages.push(t.current+2);else for(var n=t.current+1;n<=t.total;n++)t.rightPages.push(n)}),t.changePage=function(e){e>t.total?t.onPageChanged({oldPage:t.current,newPage:t.total}):1>e?t.onPageChanged({oldPage:t.current,newPage:1}):t.onPageChanged({oldPage:t.current,newPage:e})},t.submit=function(){if(t.newPage!=t.current){var n=t.pageHref(t.newPage);n?e.url(n):t.changePage(parseInt(t.newPage))}}}}}])}(),function(){"use strict";keylolApp.directive("pointLink",[function(){return{restrict:"E",templateUrl:"components/directives/point-link.html",scope:{idCode:"=",pointName:"=",type:"=",avatarUrl:"="},link:function(e,t){e.funcs={},e.linkHover=function(n){if(e.avatarUrl){var o=t.children().children().width();e.cardPopup=e.funcs.showPointCard({templateUrl:"components/popup/point-preview-card.html",controller:"PointPreviewCardController",event:n,attachSide:"bottom",align:"left",offsetX:o/2-37,inputs:{idCode:e.idCode,type:e.type}})}else e.cardPopup=e.funcs.showPointCard({templateUrl:"components/popup/point-preview-card.html",controller:"PointPreviewCardController",event:n,attachSide:"bottom",align:"left",inputs:{idCode:e.idCode,type:e.type}})}}}}])}(),function(){"use strict";keylolApp.directive("pointReview",[function(){return{restrict:"E",templateUrl:"components/directives/point-review.html",scope:{noString:"=",onClickReview:"&",bindReview:"=",isHollow:"="},link:function(e){e.levelString=["terrible","bad","not-bad","good","awesome"],e.reviewCircles=[{},{},{},{},{}],e.reviewLevel=-1,e.reviewString="",e.changeReview=function(t){for(var n in e.reviewCircles)e.reviewCircles[n].type="";for(var o=0;t>=o;o++)e.reviewCircles[o].type=e.levelString[t]},e.returnDefault=function(){e.changeReview(e.reviewLevel)},e.setReview=function(t){e.onClickReview({vote:t+1})||(e.reviewLevel=t,e.reviewString=e.levelString[t],e.bindReview=t+1)},e.bindReview&&(e.setReview(e.bindReview-1),e.returnDefault())}}}])}(),function(){"use strict";keylolApp.directive("popup",["window","$timeout",function(e,t){return{restrict:"A",scope:{showFn:"=popup"},link:function(n,o){var i={},r=[];n.showFn=function(n){var a={attachSide:"top",align:"center",offsetX:0,offsetY:0,showDelay:0,closeDelay:0};if(n&&n.event&&(n.event=$.extend({},n.event),"mouseenter"===n.event.type&&(a.showDelay=350,a.closeDelay=400)),$.extend(a,n),a.event){var c=r.indexOf(a.event.currentTarget);if(i[c])return void i[c].show(!0)}var l,s,u,d=function(){s?t.cancel(s):u=t(function(){u=null,l.then(function(e){e.closeNow()})},a.closeDelay)},m=function(n){if(u)t.cancel(u);else if(!n){var c,p;return s=t(function(){if(s=null,!$.contains(document,o[0]))return void(a.event&&"mouseenter"===a.event.type&&(delete i[p],$(a.event.currentTarget).off("mouseleave",c)));if(l=e.show({template:a.template,templateUrl:a.templateUrl,controller:a.controller,adjustScrollBar:!1,delayAppend:!0,inputs:a.inputs}),l.then(function(e){var t=e.$element.innerWidth(),n=e.$element.innerHeight();e.$element.hide();var i=o.offset(),r=o.innerWidth(),c=o.innerHeight();if("left"===a.attachSide||"right"===a.attachSide){switch(a.align){case"top":break;case"bottom":i.top=i.top+c-n;break;default:i.top=(2*i.top+c-n)/2}"left"===a.attachSide?i.left-=t:i.left+=r}else{switch(a.align){case"left":break;case"right":i.left=i.left+r-t;break;default:i.left=(2*i.left+r-t)/2}"bottom"===a.attachSide?i.top+=c:i.top-=n}i.left+=a.offsetX,i.top+=a.offsetY,e.$element.css(i),e.$element.show()}),a.event){var t;if("click"===a.event.type)l.then(function(e){return t=function(t){if(t.target===a.event.currentTarget||$.contains(a.event.currentTarget,t.target)){if(a.event.acceptCurrentTarget)return;t.stopPropagation()}t.target===e.$element[0]||$.contains(e.$element[0],t.target)||d()},document.body.addEventListener("click",t,!0),e.close}).then(function(){document.body.removeEventListener("click",t,!0)});else if("mouseenter"===a.event.type){var n=function(){m(!0)},r=function(){d()};l.then(function(e){t=function(t){t.target===e.$element[0]||$.contains(e.$element[0],t.target)||e.closeNow()},document.body.addEventListener("click",t,!0),e.$element.hover(n,r),e.close.then(function(){delete i[p],document.body.removeEventListener("click",t,!0),$(a.event.currentTarget).off("mouseleave",c),e.$element.off("mouseenter",n),e.$element.off("mouseleave",r)})})}}return l},a.showDelay),a.event&&"mouseenter"===a.event.type&&(c=function(){d()},$(a.event.currentTarget).mouseleave(c),p=r.indexOf(a.event.currentTarget),-1===p&&(p=r.push(a.event.currentTarget)-1),i[p]={show:m},s["catch"](function(){delete i[p],$(a.event.currentTarget).off("mouseleave",c)})),s.then(function(e){return e})}};return m()}}}}])}(),function(){"use strict";keylolApp.directive("proCon",[function(){return{restrict:"E",templateUrl:"components/directives/pro-con.html",scope:{isNegative:"="},require:"ngModel",link:function(e,t,n,o){e.proConString=e.isNegative?"缺":"亮",e.valueArray=[],o.$render=function(){if(o.$viewValue&&o.$viewValue.length>0){for(var t=0;t<o.$viewValue.length;t++)e.valueArray[t]=o.$viewValue[t];for(var n=o.$viewValue.length;n<e.valueArray.length;n++)e.valueArray[n]=""}else e.valueArray[0]=""},e.addValue=function(){e.valueArray.length<5&&e.valueArray.push("")},e.deleteValue=function(t){e.valueArray.length>1&&(e.valueArray.splice(t,1),e.setValue())},e.setValue=function(){for(var t=[],n=0;n<e.valueArray.length;n++)e.valueArray[n]&&""!==e.valueArray[n]&&t.push(e.valueArray[n]);o.$setViewValue(t)}}}}])}(),function(){"use strict";keylolApp.directive("simditor",["upyun","$interval","$compile","$timeout",function(e,t,n,o){return{restrict:"A",require:"ngModel",scope:{options:"=simditor",content:"=ngModel"},templateUrl:"components/directives/simditor.html",link:function(i,r,a,c){var l={toolbar:["paragraph","|","bold","italic","underline","strikethrough","|","alignment","hr","blockquote","spoiler","table","|","link","image"],tabIndent:!1,defaultImage:"assets/images/image-placeholder.svg",upload:{url:"//v0.api.upyun.com/keylol",params:{},fileKey:"file"},pasteImage:!0};i.options&&$.extend(l,i.options),l.textarea=r.find("textarea");var s=new Simditor(l),u=function(){var t=e.policy();e.signature(t).then(function(e){$.extend(s.uploader.opts.params,{policy:t,signature:e})})};u();var d=t(u,27e4);i.$on("$destroy",function(){t.cancel(d),s.destroy()}),c.$render=function(){s.setValue(c.$viewValue),n(r.find(".simditor-body").find("img"))(i),o(function(){s.trigger("valuechanged")})},s.on("valuechanged",function(){c.$setViewValue(s.getValue())})}}}])}(),function(){"use strict";keylolApp.directive("spoiler",[function(){return{restrict:"E",templateUrl:"components/directives/spoiler.html",transclude:!0,link:function(e,t){t.addClass("actionable"),t.click(function(){t.addClass("expanded"),t.find(".hint").remove(),t.find(".content").children().unwrap(),t.off("click")})}}}])}(),function(){"use strict";keylolApp.directive("webpBackground",["utils",function(e){return{restrict:"A",priority:98,link:function(t,n,o){o.$observe("webpBackground",function(t){/^(?:http:|https:)?\/\/(storage|steamcdn)\.keylol\.com\//i.test(t)?e.supportWebp.then(function(){-1===t.indexOf("!")?n.css("background-image","url("+t+"!webp)"):n.css("background-image","url("+t+".webp)")},function(){n.css("background-image","url("+t+")")}):n.css("background-image","url("+t+")")})}}}])}(),function(){"use strict";keylolApp.directive("webpSrc",["utils",function(e){return{restrict:"A",priority:98,link:function(t,n,o){o.$observe("webpSrc",function(t){/^(?:http:|https:)?\/\/(storage|steamcdn)\.keylol\.com\//i.test(t)?e.supportWebp.then(function(){-1===t.indexOf("!")?o.$set("src",t+"!webp"):o.$set("src",t+".webp")},function(){o.$set("src",t)}):o.$set("src",t)})}}}])}(),function(){"use strict";keylolApp.directive("window",["$timeout",function(e){var t;return{restrict:"E",transclude:!0,templateUrl:"components/directives/window.html",scope:{position:"@position"},compile:function(){return{post:function(n,o){t=angular.element(o[0].querySelector(".window-exit-button")),o.on("click",function(n){n.target===o[0]&&(t.hasClass("focused")||(t.addClass("focused"),e(function(){t.removeClass("focused")},900)))})}}}}}])}(),function(){"use strict";keylolApp.filter("avatarUrl",["$filter",function(e){return function(t,n){var o;switch(n){case"big":o="avatar.big";break;case"small":o="avatar.small";break;default:o="avatar.medium"}return e("uriRelocate")(t,o,"keylol://steam/avatars/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb")}}])}(),function(){"use strict";keylolApp.filter("backgroundUrl",["$filter",function(e){return function(t){return e("uriRelocate")(t,"profile.point.background","keylol://e2d611b9650daf5c08d307f24cf8b308.jpg")}}])}(),function(){"use strict";keylolApp.filter("coverUrl",["$filter",function(e){return function(t,n){var o;switch(n){case"big":o="cover.image.big";break;default:o="cover.image.small"}return e("uriRelocate")(t,o)}}])}(),function(){"use strict";keylolApp.filter("maxLength",function(){return function(e,t){var n=e;return n.length>t&&(n=n.slice(0,t-1)+"…"),n}})}(),function(){"use strict";keylolApp.filter("storeUrlToSteamDB",function(){return function(e){var t=e.match(/(?:http:|https:)\/\/store\.steampowered\.com\/app\/(\d+)/i);return t?"https://steamdb.info/app/"+t[1]+"/":void 0}})}(),function(){"use strict";keylolApp.filter("timelineThumbnailUrl",["$filter",function(e){return function(t){return e("uriRelocate")(t,"timeline.thumbnail.new","keylol://e2d611b9650daf5c08d307f24cf8b308.jpg")}}])}(),function(){"use strict";keylolApp.filter("uriRelocate",[function(){var e=function(t,n,o){if(!t||"string"!=typeof t)return o?e(o,n):null;if(0!==t.indexOf("keylol://"))return t;var i,r=n?"!"+n:"";return(i=t.match(/^keylol:\/\/([^\/]*)$/i))?"//storage.keylol.com/"+i[1]+r:(i=t.match(/^keylol:\/\/steam\/app-backgrounds\/(\d+)$/i))?"//steamcdn.keylol.com/steam/apps/"+i[1]+"/page_bg_generated.jpg"+r:(i=t.match(/^keylol:\/\/steam\/app-backgrounds\/(\d+)-([^\/]*)$/i))?"//steamcdn.keylol.com/steam/apps/"+i[1]+"/ss_"+i[2]+".jpg"+r:(i=t.match(/^keylol:\/\/steam\/app-headers\/([^\/]*)$/i))?"//steamcdn.keylol.com/steam/apps/"+i[1]+"/header.jpg"+r:(i=t.match(/^keylol:\/\/steam\/app-capsules\/([^\/]*)$/i))?"//steamcdn.keylol.com/steam/apps/"+i[1]+"/capsule_231x87.jpg"+r:(i=t.match(/^keylol:\/\/steam\/app-icons\/(\d+)-([^\/]*)$/i))?"//steamcdn.keylol.com/steamcommunity/public/images/apps/"+i[1]+"/"+i[2]+".jpg"+r:(i=t.match(/^keylol:\/\/steam\/avatars\/([^\/]*)$/i))?"//steamcdn.keylol.com/steamcommunity/public/images/avatars/"+i[1].substring(0,2)+"/"+i[1]+"_full.jpg"+r:null};return e}])}(),function(){"use strict";keylolApp.filter("userName",function(){return function(e,t){return t?"@"+e:e}})}(),function(){"use strict";keylolApp.controller("AcknowledgementsController",["pageTitle","$scope","union","$http","notification","utils","$timeout",function(e,t,n,o,i,r,a){function c(e){for(var t=s.actions,n=0;n<t.length;n++)t[n].active=!1;e.active=!0}function l(e,t){t||(s.entries.length=0,t=0),o.get(apiEndpoint+"like/my",{params:{type:e,skip:t,take:r.timelineLoadCount}}).then(function(e){s.noMoreArticle=e.data.length<r.timelineLoadCount;var t;for(var n in e.data){var o=e.data[n],i={isNew:!o.ReadByTargetUser,fromArticle:{id:o.Article.Id,text:o.Article.Title,href:"article/"+o.Article.AuthorIdCode+"/"+o.Article.SequenceNumberForAuthor},datetime:o.Time,hasBackground:!0,background:"keylol://0abeafd8e4c049bce860686bc4c04829.jpg",author:{username:o.Operator.UserName,avatarUrl:o.Operator.AvatarImage,idCode:o.Operator.IdCode},id:o.Id};o.Comment?(i.commentId=o.Comment.Id,i.types=["评论"],i.fromArticle.fromComment=!0,i.summary="认可你的评论",i.url="article/"+o.Article.AuthorIdCode+"/"+o.Article.SequenceNumberForAuthor+"#"+o.Comment.SequenceNumberForArticle):(i.types=["文章"],i.summary="认可你的文章",i.url="article/"+o.Article.AuthorIdCode+"/"+o.Article.SequenceNumberForAuthor),s.entries.push(i),function(e){a(function(){t?t=t.then(function(){return e.show=!0,a(function(){},r.timelineShowDelay)}):(e.show=!0,t=a(function(){},r.timelineShowDelay))})}(i)}t?t.then(function(){s.loadingLock=!1}):s.loadingLock=!1},function(e){i.error("未知错误",e),s.loadingLock=!1})}e.set("认可 - 其乐"),t.union=n;var s={title:{mainTitle:"认可",subTitle:"Acknowledgement"},actions:[{active:!0,text:"全部",onClick:function(){this.active||(c(this),l("All"))}},{active:!1,text:"文章",onClick:function(){this.active||(c(this),l("ArticleLike"))}},{active:!1,text:"评论",onClick:function(){this.active||(c(this),l("CommentLike"))}}],loadAction:function(){s.loadingLock=!0,s.actions[0].active?l("All",s.entries.length):s.actions[1].active?l("ArticleLike",s.entries.length):l("CommentLike",s.entries.length)},loadingLock:!0,notArticle:!0,hasDeleteButton:!0,clickable:!0,entries:[]};l("All"),n.timeline=s,n.summary={actions:[],head:{mainHead:"认可",subHead:"Acknowledgement"},background:"keylol://0abeafd8e4c049bce860686bc4c04829.jpg",defaultSum:{text:"文章/评论获得的认可"}}}])}(),function(){"use strict";keylolApp.controller("AlphaEntranceController",["pageTitle","$scope","$timeout","$rootScope","window","$window","union","$location",function(e,t,n,o,i,r,a,c){e.set("其乐 - 一个交流评测感悟的玩家社区"),t.$watch(function(){return a.$localStorage.login},function(e){e&&c.url("home")}),t.showInvitationWindow=function(){i.show({templateUrl:"components/windows/alpha-invitation.html",controller:"AlphaInvitationController"})},t.secondAnimate=!1;var l=0;t.active=0;var s;$(r).scroll(function(){t.$apply(function(){0==t.secondAnimate&&$(r).scrollTop()>=538&&(t.secondAnimate=!0),$(r).scrollTop()<1152?(t.active=0,l=0):$(r).scrollTop()>2077?(t.active=6,l=6):d($(r).scrollTop()<1337?1:$(r).scrollTop()<1522?2:$(r).scrollTop()<1707?3:$(r).scrollTop()<1892?4:5)})});var u=t.$on("$destroy",function(){$(r).unbind("scroll"),u()}),d=function(e){l!=e&&(l=e,s&&n.cancel(s),s=n(function(){t.active=e},100))}}])}(),function(){"use strict";keylolApp.controller("ArticleController",["pageTitle","$scope","union","$routeParams","$http","getAndFlushComments","notification","$location","$timeout",function(e,t,n,o,i,r,a,c,l){t.articleExist=!0,t.union=n,e.set("文章 - 其乐");var s={},u={},d={},m={};o.author&&o.article&&(i.get(apiEndpoint+"article/"+o.author+"/"+o.article).then(function(d){var p=d.data;p.authorIdCode=o.author,p.sqNumberForAuthor=o.article,e.set(p.Title+" - 其乐"),p.isMyArticle=n.$localStorage.user.IdCode===o.author,p.canEdit=p.isMyArticle||"operator"===n.$localStorage.user.StaffClaim,p.Vote&&(t.hasVote=!0,i.get(apiEndpoint+"normal-point/"+p.VoteForPoint.Id,{params:{includeVotes:!0,includeCoverDescription:!0,includeRelated:!0}}).then(function(e){var t=e.data;t.totalEvaluate=0;var n=0;for(var o in t.VoteStats)t.totalEvaluate+=t.VoteStats[o],n+=2*t.VoteStats[o]*o,p.Vote==o&&(t.highlight=o);t.votePercent=((n/t.totalEvaluate-2)/.8).toFixed(1),$.extend(u,t)},function(e){a.error("未知错误",e)})),$.extend(s,p),r(p,null,"hot"),c.hash()?r(p,c.hash(),"sequence",function(){l(function(){$("body").animate({scrollTop:$("#comment-"+c.hash()).offset().top},function(){$("#comment-"+c.hash()).addClass("highlight")})})}):r(p,1,"page"),m.changePage=function(e,t){r(p,t,"page")}},function(e){404===e.status&&(t.articleExist=!1),console.error(e)}),i.get(apiEndpoint+"user/"+o.author,{params:{includeSubscribed:o.author!=n.$localStorage.user.IdCode,includeStats:!0,includeProfilePointBackgroundImage:!0,includeReviewStats:!0,idType:"IdCode"}}).then(function(e){var t=e.data;$.extend(d,{head:{mainHead:t.UserName,subHead:t.GamerTag},avatar:t.AvatarImage,background:t.ProfilePointBackgroundImage,pointSum:{type:"个人",readerNum:t.SubscriberCount,articleNum:t.ArticleCount},id:t.Id,url:"user/"+t.IdCode,reviewCount:t.ReviewCount,shortReviewCount:t.ShortReviewCount,idCode:t.IdCode,userName:"@"+t.UserName}),t.IdCode!=n.$localStorage.user.IdCode&&(d.subscribed=t.Subscribed)},function(e){a.error("未知错误",e)})),n.summary=d,n.article=s,n.point=u,n.comments=[],n.hotComments=[],n.pageElements=m}])}(),function(){"use strict";keylolApp.controller("CommentsController",["pageTitle","$scope","union","$http","notification","utils","$timeout",function(e,t,n,o,i,r,a){function c(e){for(var t=u.actions,n=0;n<t.length;n++)t[n].active=!1;e.active=!0}function l(e){e||(u.entries.length=0,e=0),o.get(apiEndpoint+"comment/my",{params:{type:"Sent",skip:e,take:r.timelineLoadCount}}).then(function(e){u.noMoreArticle=e.data.length<r.timelineLoadCount;var t;for(var o in e.data){var i=e.data[o],c={types:["发出"],fromArticle:{fromComment:!0,text:i.Article.Title,href:"article/"+i.Article.AuthorIdCode+"/"+i.Article.SequenceNumberForAuthor},datetime:i.PublishTime,author:{username:n.$localStorage.user.UserName,avatarUrl:n.$localStorage.user.AvatarImage,idCode:n.$localStorage.user.IdCode},hasBackground:!0,background:"keylol://672a1bab71b9af43215d252471a893e0.jpg",summary:i.Content,url:"article/"+i.Article.AuthorIdCode+"/"+i.Article.SequenceNumberForAuthor+"#"+i.SequenceNumberForArticle};i.ReplyToComment&&i.ReplyToUser&&(c.commentTarget={type:"comment",author:{username:i.ReplyToUser.UserName,idCode:i.ReplyToUser.IdCode},text:i.ReplyToComment.Content,url:"article/"+i.Article.AuthorIdCode+"/"+i.Article.SequenceNumberForAuthor+"#"+i.ReplyToComment.SequenceNumberForArticle}),u.entries.push(c),function(e){a(function(){t?t=t.then(function(){return e.show=!0,a(function(){},r.timelineShowDelay)}):(e.show=!0,t=a(function(){},r.timelineShowDelay))})}(c)}t?t.then(function(){u.loadingLock=!1}):u.loadingLock=!1},function(e){i.error("未知错误",e),u.loadingLock=!1})}function s(e){e||(u.entries.length=0,e=0),o.get(apiEndpoint+"comment/my",{params:{skip:e,take:r.timelineLoadCount}}).then(function(e){u.noMoreArticle=e.data.length<r.timelineLoadCount;var t;for(var o in e.data){var i=e.data[o],c={types:["收到"],isNew:!i.ReadByTargetUser,fromArticle:{fromComment:!0,text:i.Article.Title,href:"article/"+i.Article.AuthorIdCode+"/"+i.Article.SequenceNumberForAuthor},datetime:i.PublishTime,author:{username:i.Commentator.UserName,avatarUrl:i.Commentator.AvatarImage,idCode:i.Commentator.IdCode},hasBackground:!0,background:"keylol://672a1bab71b9af43215d252471a893e0.jpg",summary:i.Content,url:"article/"+i.Article.AuthorIdCode+"/"+i.Article.SequenceNumberForAuthor+"#"+i.SequenceNumberForArticle};i.ReplyToComment&&(c.commentTarget={type:"comment",author:{username:n.$localStorage.user.UserName,idCode:n.$localStorage.user.IdCode},text:i.ReplyToComment.Content,url:"article/"+i.Article.AuthorIdCode+"/"+i.Article.SequenceNumberForAuthor+"#"+i.ReplyToComment.SequenceNumberForArticle}),u.entries.push(c),function(e){a(function(){t?t=t.then(function(){return e.show=!0,a(function(){},r.timelineShowDelay)}):(e.show=!0,t=a(function(){},r.timelineShowDelay))})}(c)}t?t.then(function(){u.loadingLock=!1}):u.loadingLock=!1},function(e){i.error("未知错误",e),u.loadingLock=!1})}e.set("评论 - 其乐"),t.union=n;var u={title:{mainTitle:"评论",subTitle:"Comments"},actions:[{active:!0,text:"收到",onClick:function(){this.active||(c(this),s())}},{active:!1,text:"发出",onClick:function(){this.active||(c(this),l())}}],loadAction:function(){u.loadingLock=!0,u.actions[0].active?s(u.entries.length):l(u.entries.length)},notArticle:!0,clickable:!0,loadingLock:!0,entries:[]};s(),n.timeline=u,n.summary={head:{mainHead:"评论",subHead:"Comments"},background:"keylol://672a1bab71b9af43215d252471a893e0.jpg",defaultSum:{text:"文章回复中的互动"}}}])}(),function(){"use strict";keylolApp.controller("HomeController",["pageTitle","$scope","union","$http","notification","window","utils","$timeout",function(e,t,n,o,i,r,a,c){e.set("其乐 - 请无视游戏与艺术之间的空隙"),t.union=n;var l={title:{mainTitle:"讯息轨道",subTitle:"Timeline"},rightButton:{avatar:"assets/images/edit-pen.png",alt:"发表新文章",text:"文",clickAction:function(){r.show({templateUrl:"components/windows/editor.html",controller:"EditorController",inputs:{options:null}})}},noArticleText:{main:"从你的游戏兴趣开始，慢慢搭建一条讯息轨道",sub:"订阅一个据点后，其收到的文章投稿会推送到这里。"},hasExpand:!0,loadingLock:!0,loadAction:function(e,t){o.get(apiEndpoint+"article/subscription",{params:e}).then(function(e){t(e)},function(e){i.error("未知错误",e)})},entries:[]};o.get(apiEndpoint+"article/subscription",{params:{take:a.timelineLoadCount}}).then(function(e){var t=e.data;if(l.noMoreArticle=t.length<a.timelineLoadCount,t.length>0){var r;for(var s in t){var u=t[s],d={types:[u.TypeName],author:{username:u.Author.UserName,avatarUrl:u.Author.AvatarImage,idCode:u.Author.IdCode},sequenceNumber:u.SequenceNumber,sources:{},voteForPoint:u.VoteForPoint,vote:u.Vote,voteColor:u.Vote?a.getVoteColor(u.Vote-1):null,datetime:u.PublishTime,title:u.Title,summary:u.Content,hasBackground:!1,thumbnail:u.ThumbnailImage,hasThumbnail:!0,url:"/article/"+u.Author.IdCode+"/"+u.SequenceNumberForAuthor,count:{like:u.LikeCount,comment:u.CommentCount}};if(u.TimelineReason)switch(u.TimelineReason){case"Like":if(d.sources.type="like",d.sources.userArray=[],u.LikeByUsers)for(var m in u.LikeByUsers)d.sources.userArray.push({name:u.LikeByUsers[m].UserName,idCode:u.LikeByUsers[m].IdCode});else d.sources.userArray.push({name:n.$localStorage.user.UserName,idCode:"/user/"+n.$localStorage.user.IdCode});break;case"Point":u.AttachedPoints?(d.sources.type="point",d.sources.points=u.AttachedPoints):d.sources=null;break;case"Publish":d.sources.type="publish"}l.entries.push(d),function(e){c(function(){r?r=r.then(function(){return e.show=!0,c(function(){},a.timelineShowDelay)}):(e.show=!0,r=c(function(){},a.timelineShowDelay))})}(d)}r?r.then(function(){l.loadingLock=!1}):l.loadingLock=!1}else o.get(apiEndpoint+"normal-point/active").then(function(e){l.activePoints=e.data;for(var t in l.activePoints){var n=l.activePoints[t];l.activePoints[t].mainName=a.getPointFirstName(n),l.activePoints[t].subName=a.getPointSecondName(n),l.activePoints[t].type=a.getPointType(n.Type)}},function(e){i.error("未知错误",e)}),l.loadingLock=!1},function(e){i.error("未知错误",e),l.loadingLock=!1}),n.timeline=l}])}(),function(){"use strict";keylolApp.controller("NotFoundController",["pageTitle",function(e){e.set("404 Not Found - 其乐")}])}(),function(){"use strict";keylolApp.controller("PointController",["pageTitle","$scope","union","$routeParams","$http","utils","notification","window","$location","$timeout",function(e,t,n,o,i,r,a,c,l,s){t.union=n,t.pointExist=!0,t.isInPoint=!0;var u={},d={},m={},p={title:{mainTitle:"讯息轨道",subTitle:"Timeline"},rightButton:{avatar:"assets/images/edit-pen.png",alt:"发表新文章",text:"文",clickAction:function(){c.show({templateUrl:"components/windows/editor.html",controller:"EditorController",inputs:{options:null}})}},publishOnly:/\/user\/.+\/publications/i.test(l.url()),datetime:"outBlock",hasExpand:!0,loadingLock:!0,entries:[]};o.userIdCode&&(t.isInPoint=!1,p.noArticleText={main:"这位用户尚未发布或认可任何文章",sub:"订阅并关注即将到来的动态。"},p.loadAction=function(e,t){i.get(apiEndpoint+"article/user/"+o.userIdCode,{params:e}).then(function(e){t(e)},function(e){a.error("未知错误",e)})},i.get(apiEndpoint+"user/"+o.userIdCode,{params:{includeStats:!0,
idType:"IdCode",includeProfilePointBackgroundImage:!0,includeSubscribed:!0}}).then(function(t){var c=t.data;c.IdCode!=n.$localStorage.user.IdCode&&(u.subscribed=c.Subscribed),r.addRecentBroswe("ProfilePoint",c.UserName,c.IdCode),e.set(c.UserName+" - 其乐"),$.extend(d,c),$.extend(u,{head:{mainHead:c.UserName,subHead:c.GamerTag},avatar:c.AvatarImage,background:c.ProfilePointBackgroundImage,pointSum:{type:"个人",readerNum:c.SubscriberCount,articleNum:c.ArticleCount},id:c.Id,url:"user/"+c.IdCode}),i.get(apiEndpoint+"article/user/"+o.userIdCode,{params:{idType:"IdCode",publishOnly:p.publishOnly,take:r.timelineLoadCount}}).then(function(e){var t=e.data;if(p.noMoreArticle=t.length<r.timelineLoadCount,t.length>0){var n;for(var o in t){var l=t[o];l.Author||(l.Author=c);var u={types:[l.TypeName],author:{username:l.Author.UserName,avatarUrl:l.Author.AvatarImage,idCode:l.Author.IdCode},sequenceNumber:l.SequenceNumber,sources:{},voteForPoint:l.VoteForPoint,vote:l.Vote,voteColor:l.Vote?r.getVoteColor(l.Vote-1):null,datetime:l.PublishTime,title:l.Title,summary:l.Content,hasBackground:!1,thumbnail:l.ThumbnailImage,hasThumbnail:!0,url:"/article/"+l.Author.IdCode+"/"+l.SequenceNumberForAuthor,count:{like:l.LikeCount,comment:l.CommentCount}};if(l.TimelineReason)switch(l.TimelineReason){case"Like":if(u.sources.type="like",u.sources.userArray=[],l.LikeByUsers)for(var d in l.LikeByUsers)u.sources.userArray.push({name:l.LikeByUsers[d].UserName,idCode:l.LikeByUsers[d].IdCode});else u.sources.userArray.push({name:c.UserName,idCode:c.IdCode});break;case"Point":u.sources.type="point",u.sources.points=[];for(var d in l.AttachedPoints)u.sources.points.push({name:l.AttachedPoints[d][l.AttachedPoints[d].PreferredName+"Name"],idCode:l.AttachedPoints[d].IdCode});break;case"Publish":u.sources.type="publish"}p.entries.push(u),function(e){s(function(){n?n=n.then(function(){return e.show=!0,s(function(){},r.timelineShowDelay)}):(e.show=!0,n=s(function(){},r.timelineShowDelay))})}(u)}n?n.then(function(){p.loadingLock=!1}):p.loadingLock=!1}else i.get(apiEndpoint+"normal-point/active").then(function(e){p.activePoints=e.data;for(var t in p.activePoints){var n=p.activePoints[t];p.activePoints[t].mainName=r.getPointFirstName(n),p.activePoints[t].subName=r.getPointSecondName(n),p.activePoints[t].type=r.getPointType(n.Type)}},function(e){a.error("未知错误",e)}),p.loadingLock=!1},function(e){a.error("未知错误",e),p.loadingLock=!1})},function(e){t.pointExist=!1,a.error("未知错误",e)})),o.pointIdCode&&(p.noArticleText={main:"当前据点尚未收到任何文章投稿",sub:"考虑成为首篇文章的作者？"},p.loadAction=function(e,t){i.get(apiEndpoint+"article/point/"+o.pointIdCode,{params:e}).then(function(e){t(e)},function(e){a.error("未知错误",e)})},i.get(apiEndpoint+"normal-point/"+o.pointIdCode,{params:{includeStats:!0,includeVotes:!0,includeSubscribed:!0,includeRelated:!0,includeCoverDescription:!0,includeMore:!0,idType:"IdCode"}}).then(function(o){var i=o.data;n.associatedPoints=i.AssociatedPoints,"Game"===i.Type&&(t.hasVote=!0),i.totalEvaluate=0;var a=0;for(var c in i.VoteStats)i.totalEvaluate+=i.VoteStats[c],a+=2*i.VoteStats[c]*c,i.VoteStats[c]>0&&(!i.highlight||i.VoteStats[c]>=i.VoteStats[i.highlight])&&(i.highlight=c);i.votePercent=((a/i.totalEvaluate-2)/.8).toFixed(1);var l=r.getPointFirstName(i);e.set(l+" - 其乐"),r.addRecentBroswe("NormalPoint",l,i.IdCode),$.extend(m,i),$.extend(u,{head:{mainHead:r.getPointFirstName(i),subHead:r.getPointSecondName(i)},avatar:i.AvatarImage,subscribed:i.Subscribed,background:i.BackgroundImage,pointSum:{type:r.getPointType(i.Type),readerNum:i.SubscriberCount,articleNum:i.ArticleCount},id:i.Id,url:"point/"+i.IdCode})},function(e){t.pointExist=!1,a.error("未知错误",e)}),i.get(apiEndpoint+"article/point/"+o.pointIdCode,{params:{idType:"IdCode",take:r.timelineLoadCount}}).then(function(e){var t=e.data;if(p.noMoreArticle=t.length<r.timelineLoadCount,t.length>0){var n;for(var o in t){var c=t[o],l={types:[c.TypeName],author:{username:c.Author.UserName,avatarUrl:c.Author.AvatarImage,idCode:c.Author.IdCode},voteForPoint:c.VoteForPoint,vote:c.Vote,voteColor:c.Vote?r.getVoteColor(c.Vote-1):null,sequenceNumber:c.SequenceNumber,datetime:c.PublishTime,title:c.Title,summary:c.Content,hasBackground:!1,thumbnail:c.ThumbnailImage,hasThumbnail:!0,url:"/article/"+c.Author.IdCode+"/"+c.SequenceNumberForAuthor,count:{like:c.LikeCount,comment:c.CommentCount}};p.entries.push(l),function(e){s(function(){n?n=n.then(function(){return e.show=!0,s(function(){},r.timelineShowDelay)}):(e.show=!0,n=s(function(){},r.timelineShowDelay))})}(l)}n?n.then(function(){p.loadingLock=!1}):p.loadingLock=!1}else i.get(apiEndpoint+"normal-point/active").then(function(e){p.activePoints=e.data;for(var t in p.activePoints){var n=p.activePoints[t];p.activePoints[t].mainName=r.getPointFirstName(n),p.activePoints[t].subName=r.getPointSecondName(n),p.activePoints[t].type=r.getPointType(n.Type)}},function(e){a.error("未知错误",e)}),p.loadingLock=!1},function(e){a.error("未知错误",e),p.loadingLock=!1})),n.timeline=p,n.user=d,n.point=m,n.summary=u}])}(),function(){"use strict";keylolApp.controller("PostController",["pageTitle","$scope","union",function(e,t,n){e.set("邮政 - 其乐"),t.union=n,n.summary={actions:[],head:{mainHead:"邮政服务",subHead:"Postal Services"},background:"04be114e21692aa38afe2e4d1bc605b6.png",defaultSum:{text:"社区功能页面"}},n.timeline={title:{mainTitle:"邮政服务",subTitle:"Postal Services"},rightButton:{avatar:"assets/images/message-edit.png",alt:"发送私信"},entries:[{types:["私信"],privateMesNum:{number:1,hasNew:!1},author:{username:"crakyGALU",avatarUrl:"assets/images/exit.svg"},summary:"说起这个警匪死磕的话，相比正玩家们没有不知道那大名鼎鼎的CF啊不对CS，也就是《反恐精英（Counter-Strike）》，这款游戏的出现让警匪对殴的模式风靡全球，至今依然有大批玩家热衷于此，除此之外类似的游戏也有不少，例如《彩虹六号系列》，例如《收获日系列》等等，如今FPS界极其有影响力的战地系列也开始涉及此类题材，眼下BETA版本已经开始测试，本篇评测是根据测试版而来，所以并不代表游戏的最终品质！"}]}}])}(),function(){"use strict";keylolApp.controller("ReadersController",["pageTitle","$scope","union","$http","notification","utils","$timeout",function(e,t,n,o,i,r,a){t.union=n,t.searchExist=!0;var c={head:{mainHead:n.$localStorage.user.UserName,subHead:n.$localStorage.user.GamerTag},avatar:n.$localStorage.user.AvatarImage,pointSum:{type:"个人",readerNum:n.$localStorage.user.SubscriberCount,articleNum:n.$localStorage.user.ArticleCount}};e.set(n.$localStorage.user.UserName+" 的读者 - 其乐"),o.get(apiEndpoint+"user/"+n.$localStorage.user.IdCode,{params:{idType:"IdCode",includeProfilePointBackgroundImage:!0}}).then(function(e){c.background=e.data.ProfilePointBackgroundImage},function(e){i.error("未知错误",e)});var l={title:{mainTitle:"搜索结果",subTitle:"Search Result"},cannotClick:!0,loadAction:function(){l.loadingLock=!0,o.get(apiEndpoint+"user/my",{params:{take:r.timelineLoadCount,skip:l.entries.length}}).then(function(e){l.noMoreArticle=e.data.length<r.timelineLoadCount;var t;if(e.data.length>0){l.searchNotFound=!1;for(var n in e.data){var o=e.data[n];l.searchNotFound=!1;var i={types:["个人"],pointInfo:{reader:o.SubscriberCount,article:o.ArticleCount},title:o.UserName,summary:o.GamerTag,hasBackground:!0,background:o.ProfilePointBackgroundImage,pointAvatar:o.AvatarImage,url:"user/"+o.IdCode,isUser:!0,id:o.Id};l.entries.push(i),function(e){a(function(){t?t=t.then(function(){return e.show=!0,a(function(){},r.timelineShowDelay)}):(e.show=!0,t=a(function(){},r.timelineShowDelay))})}(i)}}else l.searchNotFound=!0;t?t.then(function(){l.loadingLock=!1}):l.loadingLock=!1},function(e){i.error("未知错误",e),l.loadingLock=!1})},entries:[]};l.loadAction(),n.timeline=l,n.summary=c}])}(),function(){"use strict";keylolApp.controller("RelatedController",["pageTitle","$scope","union","$http","notification","$routeParams","utils","$timeout",function(e,t,n,o,i,r,a,c){t.searchExist=!0,t.union=n,r.idCode&&r.type||(t.searchExist=!1);var l,s={};switch(r.type){case"Genre":l="流派";break;case"Tag":l="特性";break;case"Series":l="系列";break;case"Publisher":l="历代发行";break;case"Developer":l="历代开发";break;default:t.searchExist=!1}o.get(apiEndpoint+"normal-point/"+r.idCode,{params:{includeStats:!0,includeSubscribed:!0,idType:"IdCode"}}).then(function(t){var n=t.data;e.set(a.getPointFirstName(n)+" - "+l+" 的游戏 - 其乐"),$.extend(s,{head:{mainHead:a.getPointFirstName(n),subHead:a.getPointSecondName(n)},avatar:n.AvatarImage,subscribed:n.Subscribed,background:n.BackgroundImage,pointSum:{type:a.getPointType(n.Type),readerNum:n.SubscriberCount,articleNum:n.ArticleCount},id:n.Id,url:"point/"+n.IdCode})},function(e){t.searchExist=!1,i.error("未知错误",e)});var u={title:{mainTitle:"搜索结果",subTitle:"Search Result"},cannotClick:!0,loadAction:function(){u.loadingLock=!0,o.get(apiEndpoint+"normal-point/"+r.idCode+"/games",{params:{take:a.timelineLoadCount,skip:u.entries.length,idType:"IdCode",includeStats:!0,relationship:r.type}}).then(function(e){u.noMoreArticle=e.data.length<a.timelineLoadCount;var t;if(e.data.length>0){u.searchNotFound=!1;var n;for(var o in e.data){var i=e.data[o];n={types:[a.getPointType(i.Type)],pointInfo:{reader:e.data[o].SubscriberCount,article:e.data[o].ArticleCount},title:a.getPointFirstName(i),summary:a.getPointSecondName(i),hasBackground:!0,isPoint:!0,background:i.BackgroundImage,pointAvatar:i.AvatarImage,url:"point/"+i.IdCode,subscribed:!0,id:i.Id},u.entries.push(n),function(e){c(function(){t?t=t.then(function(){return e.show=!0,c(function(){},a.timelineShowDelay)}):(e.show=!0,t=c(function(){},a.timelineShowDelay))})}(n)}}else u.searchNotFound=!0;t?t.then(function(){u.loadingLock=!1}):u.loadingLock=!1},function(e){i.error("未知错误",e),u.loadingLock=!1})},entries:[]};u.loadAction(),n.timeline=u,n.summary=s}])}(),function(){"use strict";keylolApp.controller("SearchResultsController",["pageTitle","$scope","union","$http","notification","$routeParams","$location","utils","$timeout",function(e,t,n,o,i,r,a,c,l){t.searchExist=!0,t.union=n,r.searchType&&r.keyword||(t.searchExist=!1),e.set(r.keyword+" 的搜索结果 - 其乐");var s={actions:[],head:{mainHead:r.keyword,subHead:"的搜索结果"},background:"keylol://18714f31d985cb8e8b59661cabd9d23a.jpg",defaultSum:{text:""}},u={title:{mainTitle:"搜索结果",subTitle:"Search Result"},actions:[{active:!1,text:"据点",onClick:function(){a.url("search/point/"+encodeURIComponent(r.keyword))}},{active:!1,text:"文章",onClick:function(){a.url("search/article/"+encodeURIComponent(r.keyword))}},{active:!1,text:"用户",onClick:function(){a.url("search/user/"+encodeURIComponent(r.keyword))}},{active:!1,text:"全站",onClick:function(){}}],entries:[]};switch(r.searchType){case"point":u.actions[0].active=!0,u.loadAction=function(){u.loadingLock=!0;var e=u.entries.length;o.get(apiEndpoint+"normal-point/keyword/"+encodeURIComponent(r.keyword),{params:{full:!0,skip:e,take:c.timelineLoadCount}}).then(function(t){var n=t.headers("X-Total-Record-Count");s.defaultSum.text="找到 "+n+" 个符合的项目",u.noMoreArticle=t.data.length<c.timelineLoadCount;var o;if(n>0){e||(s.background=t.data[0].BackgroundImage),u.searchNotFound=!1;for(var i in t.data){var r=t.data[i],a={types:[c.getPointType(r.Type)],pointInfo:{reader:r.SubscriberCount,article:r.ArticleCount},hasBackground:!0,background:r.BackgroundImage,pointAvatar:r.AvatarImage,url:"point/"+r.IdCode,isPoint:!0,subscribed:r.Subscribed,id:r.Id};a.title=c.getPointFirstName(r),a.summary=c.getPointSecondName(r),u.entries.push(a),function(e){l(function(){o?o=o.then(function(){return e.show=!0,l(function(){},c.timelineShowDelay)}):(e.show=!0,o=l(function(){},c.timelineShowDelay))})}(a)}}else u.searchNotFound=!0;o?o.then(function(){u.loadingLock=!1}):u.loadingLock=!1},function(e){i.error("未知错误",e),u.loadingLock=!1})},u.loadAction();break;case"article":u.actions[1].active=!0,u.loadAction=function(){u.loadingLock=!0;var e=u.entries.length;o.get(apiEndpoint+"article/keyword/"+encodeURIComponent(r.keyword),{params:{full:!0,skip:e,take:c.timelineLoadCount}}).then(function(t){var n=t.headers("X-Total-Record-Count");if(s.defaultSum.text="找到 "+n+" 个符合的项目",u.noMoreArticle=t.data.length<c.timelineLoadCount,n>0){e||(s.background=t.data[0].ThumbnailImage),u.searchNotFound=!1;var o;for(var i in t.data){var r=t.data[i],a={types:[r.TypeName],author:{username:r.Author.UserName,avatarUrl:r.Author.AvatarImage,idCode:r.Author.IdCode},voteForPoint:r.VoteForPoint,sequenceNumber:r.SequenceNumber,datetime:r.PublishTime,title:r.Title,summary:r.Content,hasBackground:!1,thumbnail:r.ThumbnailImage,hasThumbnail:!0,url:"/article/"+r.Author.IdCode+"/"+r.SequenceNumberForAuthor,count:{like:r.LikeCount,comment:r.CommentCount}};u.entries.push(a),function(e){l(function(){o?o=o.then(function(){return e.show=!0,l(function(){},c.timelineShowDelay)}):(e.show=!0,o=l(function(){},c.timelineShowDelay))})}(a)}}else u.searchNotFound=!0;o?o.then(function(){u.loadingLock=!1}):u.loadingLock=!1},function(e){i.error("未知错误",e),u.loadingLock=!1})},u.loadAction();break;case"user":u.loadAction=function(){},u.loadingLock=!0,u.noMoreArticle=!0,u.actions[2].active=!0,o.get(apiEndpoint+"user/"+encodeURIComponent(r.keyword),{params:{idType:"UserName",includeStats:!0,includeSubscribed:!0,includeProfilePointBackgroundImage:!0}}).then(function(e){if(e.data){var t=e.data;s.background=t.ProfilePointBackgroundImage,u.searchNotFound=!1,s.defaultSum.text="找到 1 个符合的项目",u.entries.push({types:["个人"],pointInfo:{reader:t.SubscriberCount,article:t.ArticleCount},show:!0,hasBackground:!0,background:t.ProfilePointBackgroundImage,title:t.UserName,summary:t.GamerTag,pointAvatar:t.AvatarImage,url:"user/"+t.IdCode,isUser:!0,id:t.Id}),t.IdCode!=n.$localStorage.user.IdCode&&(u.entries[0].subscribed=t.Subscribed)}u.loadingLock=!1},function(e){404===e.status?s.defaultSum.text="找到 0 个符合的项目":i.error("未知错误",e),u.loadingLock=!1,u.searchNotFound=!0})}n.timeline=u,n.summary=s}])}(),function(){"use strict";keylolApp.controller("SubscriptionsController",["pageTitle","$scope","union","$http","notification","$location","utils","$timeout",function(e,t,n,o,i,r,a,c){t.union=n,t.searchExist=!0;var l={head:{mainHead:n.$localStorage.user.UserName,subHead:n.$localStorage.user.GamerTag},avatar:n.$localStorage.user.AvatarImage,pointSum:{type:"个人",readerNum:n.$localStorage.user.SubscriberCount,articleNum:n.$localStorage.user.ArticleCount}};e.set(n.$localStorage.user.UserName+" 的订阅 - 其乐"),o.get(apiEndpoint+"user/"+n.$localStorage.user.IdCode,{params:{idType:"IdCode",includeProfilePointBackgroundImage:!0}}).then(function(e){l.background=e.data.ProfilePointBackgroundImage},function(e){i.error("未知错误",e)});var s={title:{mainTitle:"搜索结果",subTitle:"Search Result"},cannotClick:!0,loadAction:function(){s.loadingLock=!0,o.get(apiEndpoint+"user-point-subscription/my",{params:{take:a.timelineLoadCount,skip:s.entries.length}}).then(function(e){s.noMoreArticle=e.data.length<a.timelineLoadCount;var t;if(e.data.length>0){s.searchNotFound=!1;var n;for(var o in e.data){if(e.data[o].NormalPoint){var i=e.data[o].NormalPoint;n={types:[a.getPointType(i.Type)],pointInfo:{reader:e.data[o].SubscriberCount,article:e.data[o].ArticleCount},title:a.getPointFirstName(i),summary:a.getPointSecondName(i),hasBackground:!0,isPoint:!0,background:i.BackgroundImage,pointAvatar:i.AvatarImage,url:"point/"+i.IdCode,subscribed:!0,id:i.Id}}else if(e.data[o].User){var r=e.data[o].User;s.searchNotFound=!1,n={types:["个人"],pointInfo:{reader:e.data[o].SubscriberCount,article:e.data[o].ArticleCount},subscribed:!0,title:r.UserName,summary:r.GamerTag,hasBackground:!0,background:r.ProfilePointBackgroundImage,pointAvatar:r.AvatarImage,url:"user/"+r.IdCode,isUser:!0,id:r.Id}}s.entries.push(n),function(e){c(function(){t?t=t.then(function(){return e.show=!0,c(function(){},a.timelineShowDelay)}):(e.show=!0,t=c(function(){},a.timelineShowDelay))})}(n)}}else s.searchNotFound=!0;t?t.then(function(){s.loadingLock=!1}):s.loadingLock=!1},function(e){i.error("未知错误",e),s.loadingLock=!1})},entries:[]};s.loadAction(),n.timeline=s,n.summary=l}])}(),function(){"use strict";keylolApp.controller("ArticleTypeSelectorController",["$scope","close","selectedIndex","articleTypes",function(e,t,n,o){e.articleTypes=o,e.selectedIndex=n,e.select=function(e){t(e)}}])}(),function(){"use strict";keylolApp.controller("EntryFilterController",["$scope","selectedIndexes","close","types",function(e,t,n,o){t&&(e.selectedIndexes=t.slice()),e.entryTypes=o,e.confirm=function(){n(e.selectedIndexes)}}])}(),function(){"use strict";keylolApp.controller("OperationFeedbackController",["$scope","close","options","$timeout",function(e,t,n,o){e.options=n,"attention"!=e.options.type&&o(function(){t()},3e3),e.close=function(e){t(e)}}])}(),function(){"use strict";keylolApp.controller("PointPreviewCardController",["$scope","idCode","type","$timeout","$http","utils","notification","union",function(e,t,n,o,i,r,a,c){if(e.loading=!0,"point"===n)c.pointCards||(c.pointCards={}),c.pointCards[t]?(e.loading=!1,e.data=c.pointCards[t]):i.get(apiEndpoint+"normal-point/"+t,{params:{includeStats:!0,includeSubscribed:!0,idType:"IdCode"}}).then(function(n){var o=n.data;e.data={id:o.Id,subscribed:o.Subscribed,head:{},avatar:o.AvatarImage,background:o.BackgroundImage,pointSum:{type:r.getPointType(o.Type),readerNum:o.SubscriberCount,articleNum:o.ArticleCount}},e.data.head.mainHead=r.getPointFirstName(o),e.data.head.subHead=r.getPointSecondName(o),c.pointCards&&(c.pointCards[t]=e.data),e.loading=!1},function(e){a.error("据点卡片请求错误",e)});else if(c.userCards||(c.userCards={}),c.userCards[t])e.loading=!1,e.data=c.userCards[t];else{var l=!0;t===c.$localStorage.user.IdCode&&(l=!1),i.get(apiEndpoint+"user/"+t,{params:{includeStats:!0,includeSubscribed:l,includeProfilePointBackgroundImage:!0,idType:"IdCode"}}).then(function(n){var o=n.data;e.data={id:o.Id,subscribed:o.Subscribed,head:{mainHead:o.UserName,subHead:o.GamerTag},avatar:o.AvatarImage,background:o.ProfilePointBackgroundImage,pointSum:{type:"个人",readerNum:o.SubscriberCount,articleNum:o.ArticleCount}},c.userCards[t]=e.data,e.loading=!1},function(e){a.error("据点卡片请求错误",e)})}e.subscribeDisabled=!1,e.subscribe=function(t){e.subscribeDisabled=!0,i.post(apiEndpoint+"user-point-subscription",{},{params:{pointId:t}}).then(function(){a.success("据点已订阅，其今后收到的文章投稿将推送到你的首页"),e.data.subscribed=!0,e.subscribeDisabled=!1,e.data.pointSum.readerNum++,c.$localStorage.user.SubscribedPointCount++},function(e){a.error("未知错误",e)})},e.unsubscribe=function(t){e.subscribeDisabled=!0,a.attention("退订并不再接收此据点的文章推送",[{action:"退订",value:!0},{action:"取消"}]).then(function(n){n?i["delete"](apiEndpoint+"user-point-subscription",{params:{pointId:t}}).then(function(){a.success("据点已退订"),e.data.subscribed=!1,e.data.pointSum.readerNum--,c.$localStorage.user.SubscribedPointCount--},function(e){a.error("未知错误",e)})["finally"](function(){e.subscribeDisabled=!1}):e.subscribeDisabled=!1})}}])}(),function(){"use strict";keylolApp.controller("PointSelectorController",["$scope","$window","close","union","selected","pointArray","utils","window",function(e,t,n,o,i,r,a,c){e.pointArray=r,e.pointArray.push({AvatarImage:"assets/images/addition-icon.png",ChineseName:"开设新据点",EnglishName:"没有找到你要的游戏？",PreferredName:"Chinese"}),e.utils=a;for(var l in e.pointArray)e.pointArray[l].selected=!1;e.pointArray[i].selected=!0,e.changeSelector=function(t){e.pointArray[i].selected=!1,i=t,e.pointArray[t].selected=!0},e.selectPoint=function(){i!==e.pointArray.length-1?(e.pointArray[i].selected=!1,n(e.pointArray[i])):c.show({templateUrl:"components/windows/shop-link.html",controller:"ShopLinkController"})},o.keydownCallback=function(t){e.$apply(function(){40==t.keyCode?i<e.pointArray.length-1?e.changeSelector(i+1):e.changeSelector(0):38==t.keyCode?i>0?e.changeSelector(i-1):e.changeSelector(e.pointArray.length-1):13==t.keyCode&&(e.selectPoint(t),t.preventDefault())})},t.addEventListener("keydown",o.keydownCallback,!0)}])}(),function(){"use strict";keylolApp.controller("RelatedGamesController",["$scope","close","type","count","idCode","$http","notification","$filter","utils",function(e,t,n,o,i,r,a,c,l){switch(e.count=o,e.utils=l,e.idCode=i,e.type=n,e.gameYears=[],n){case"Genre":e.typeText="此流派";break;case"Tag":e.typeText="此特性";break;case"Series":e.typeText="此系列";break;case"Publisher":e.typeText="历代发行";break;case"Developer":e.typeText="历代开发"}r.get(apiEndpoint+"normal-point/"+i+"/games",{params:{relationship:n,idType:"IdCode"}}).then(function(t){var n=t.data;e.gameYears.push({year:c("date")(n[0].ReleaseDate,"yyyy"),games:[n[0]]});var o=1,i=e.gameYears[0];console.log(n);for(var r=1;r<n.length;r++)if(c("date")(n[r].ReleaseDate,"yyyy")===i.year){if(i.games.push(n[r]),i.games.length%3===1&&o++,3===o&&i.games.length%3===0)break}else{if(3===o)break;i={year:c("date")(n[r].ReleaseDate,"yyyy"),games:[n[r]]},e.gameYears.push(i),o++}},function(e){a.error("游戏据点列表获取失败",e)})}])}(),function(){"use strict";keylolApp.controller("SearchSelectorController",["$scope","union","$location","options","$http","notification","utils","window",function(e,t,n,o,i,r,a,c){e.onSearching=o.onSearching,e.filterArray=t.searchFilter;var l=function(t){if(o.searchText)switch(t){case"据点":i.get(apiEndpoint+"normal-point/keyword/"+encodeURIComponent(o.searchText)).then(function(t){if(t.data.length>0){e.resultArray=[];for(var n in t.data){var o=t.data[n],i={avatar:o.AvatarImage,type:a.getPointType(o.Type),url:"point/"+o.IdCode};i.mainTitle=a.getPointFirstName(o),i.subTitle=a.getPointSecondName(o),e.resultArray.push(i)}}else e.resultArray=void 0,e.notFound=!0},function(e){r.error("未知错误",e)});break;case"文章":i.get(apiEndpoint+"article/keyword/"+encodeURIComponent(o.searchText)).then(function(t){if(t.data.length>0){e.resultArray=[];for(var n in t.data){var o=t.data[n];e.resultArray.push({mainTitle:o.Title,articleInfo:{acknowledgeNum:o.LikeCount,commentNum:o.CommentCount},url:"article/"+o.AuthorIdCode+"/"+o.SequenceNumberForAuthor})}}else e.resultArray=void 0,e.notFound=!0},function(e){r.error("未知错误",e)});break;case"用户":i.get(apiEndpoint+"user/"+encodeURIComponent(o.searchText),{params:{idType:"UserName"}}).then(function(t){if(t.data){e.resultArray=[];var n=t.data;e.resultArray.push({mainTitle:n.UserName,subTitle:n.GamerTag,avatar:n.AvatarImage,type:"个人",url:"user/"+n.IdCode,isUser:!0})}},function(t){404===t.status?(e.resultArray=void 0,e.notFound=!0):r.error("未知错误",response)});break;default:e.resultArray=void 0,e.notFound=!0}};for(var s in e.filterArray)e.filterArray[s].active===!0&&(e.filterText=e.filterArray[s].text);e.$watch(function(){return o.searchText},function(){l(e.filterText)}),e.showPointAppealWindow=function(){c.show({templateUrl:"components/windows/shop-link.html",controller:"ShopLinkController"})},e.changeFilter=function(t){if(!e.filterArray[t].active){for(var n in e.filterArray)e.filterArray[n].active=!1;e.filterArray[t].active=!0,e.filterText=e.filterArray[t].text,l(e.filterText)}},e.jumpTo=function(e){n.url(e)}}])}(),function(){"use strict";keylolApp.provider("apiEndpoint",function(){var e="";return{setEndPoint:function(t){e=t},$get:[function(){return e}]}})}(),function(){"use strict";keylolApp.constant("articleTypes",[{name:"评",description:"感悟、心得、体验、报告",allowVote:!0},{name:"研",description:"攻略、技术、成就、教程",allowVote:!1},{name:"讯",description:"新闻、购物、更新、竞技",allowVote:!1},{name:"谈",description:"聊天、灌水、吐槽、杂文",allowVote:!1},{name:"档",description:"声画、模组、插件、汉化",allowVote:!1}])}(),function(){"use strict";keylolApp.factory("getAndFlushComments",["$http","union","notification","utils",function(e,t,n,o){var i=function(e,n){var i=/^((?:#\d+[ \t]*)+)(?:$|[ \t]+)/gm,r=/#(\d+)/g;return o.escapeHtml(e).replace(i,function(e){return e.replace(r,function(e){var o=parseInt(e.slice(1,e.length));return n>o?'<a href="article/'+t.article.authorIdCode+"/"+t.article.sqNumberForAuthor+"#"+o+'">'+e+"</a>":e})})};return function(o,r,a,c){if(c||(c=function(){}),"hot"==a)e.get(apiEndpoint+"comment",{params:{articleId:o.Id,orderBy:"LikeCount",desc:!0,take:3}}).then(function(e){var n=e.data,r=[];for(var a in n)if(n[a].LikeCount>=5){var c=n[a];c.Commentator.IdCode==o.AuthorIdCode&&(c.Commentator.isAuthor=!0),c.LikeCount>0&&(c.hasLike=!0),c.Commentator.IdCode==t.$localStorage.user.IdCode&&(c.cannotLike=!0),c.Content=i(c.Content,c.SequenceNumberForArticle),r.push(c)}$.extend(t.hotComments,r)},function(e){n.error("未知错误",e)});else if("page"==a){var l=r;e.get(apiEndpoint+"comment",{params:{articleId:o.Id,skip:1==l?0:17+20*(l-2),take:1==l?17:20}}).then(function(e){var n=e.data;for(var r in n)n[r].Commentator.IdCode==o.AuthorIdCode&&(n[r].Commentator.isAuthor=!0),n[r].LikeCount>0&&(n[r].hasLike=!0),n[r].Commentator.IdCode==t.$localStorage.user.IdCode&&(n[r].cannotLike=!0),n[r].Content=i(n[r].Content,n[r].SequenceNumberForArticle);t.article.totalComments=e.headers("X-Total-Record-Count"),t.pageElements.totalPages=t.article.totalComments<=17?1:parseInt((t.article.totalComments-18)/20)+2,t.pageElements.currPage=l,t.comments.length=0,$.extend(t.comments,n)},function(e){n.error("未知错误",e)})}else{var s=r;e.get(apiEndpoint+"comment",{params:{articleId:o.Id,skip:17>=s?0:20*parseInt((s-17)/20)+17,take:17>=s?17:20}}).then(function(e){var n=e.data;for(var r in n)n[r].Commentator.IdCode==o.AuthorIdCode&&(n[r].Commentator.isAuthor=!0),n[r].LikeCount>0&&(n[r].hasLike=!0),n[r].Commentator.IdCode==t.$localStorage.user.IdCode&&(n[r].cannotLike=!0),n[r].Content=i(n[r].Content,n[r].SequenceNumberForArticle);t.article.totalComments=e.headers("X-Total-Record-Count"),t.pageElements.totalPages=t.article.totalComments<=17?1:parseInt((t.article.totalComments-18)/20)+2,t.pageElements.currPage=17>=s?1:parseInt((s-17)/20)+2,t.comments.length=0,$.extend(t.comments,n),c()},function(e){n.error("评论刷新失败",e)})}}}])}(),function(){"use strict";keylolApp.factory("notification",["window",function(e){function t(){var t,n=this;n.show=function(n){var o={templateUrl:"components/popup/operation-feedback.html",controller:"OperationFeedbackController",adjustScrollBar:!1,global:!0,inputs:{options:n}};t=t?t.then(function(e){return e.close}).then(function(){return e.show(o)}):e.show(o);var i;return t.then(function(e){return i=function(t){t.target===e.$element[0]||$.contains(e.$element[0],t.target)||e.closeNow()},document.body.addEventListener("click",i,!0),e.close}).then(function(){document.body.removeEventListener("click",i,!0)}),t.then(function(e){return e.close})},n.success=function(e){return n.show({type:"success",title:"成功",subtitle:"Success",message:e})},n.process=function(e){return n.show({type:"process",title:"处理中",subtitle:"Processing",message:e})},n.error=function(e,t){if(t&&console.error(t),!t||400!==t.status)return n.show({type:"error",title:"错误",subtitle:"Error",message:e});for(var o in t.data.ModelState)if(t.data.ModelState.hasOwnProperty(o)&&"function"!=typeof o)return n.show({type:"error",title:"错误",subtitle:"Error",message:t.data.ModelState[o][0]})},n.attention=function(e,t){return n.show({type:"attention",title:"注意",subtitle:"Attention",message:e,actions:t})}}return new t}])}(),function(){"use strict";keylolApp.provider("pageTitle",function(){var e="";return{setLoadingTitle:function(t){return t&&(e=t),e},$get:["$rootScope",function(t){return{set:function(e){t.pageTitle=e},loading:function(){t.pageTitle=e}}}]}})}(),function(){"use strict";keylolApp.factory("union",["$localStorage","$sessionStorage","$rootScope",function(e,t,n){var o={$localStorage:e,$sessionStorage:t};return n.$on("$routeChangeSuccess",function(){for(var n in o)delete o[n];o.$localStorage=e,o.$sessionStorage=t}),o}])}(),function(){"use strict";keylolApp.factory("upyun",["$http","base64","Upload",function(e,t,n){function o(){var o=this;o.policy=function(){var e={bucket:"keylol","save-key":"{filemd5}{.suffix}",expiration:Math.round((new Date).getTime()/1e3)+300,"content-length-range":"0,5242880"};return t.encode(JSON.stringify(e))},o.signature=function(t){return e.post(apiEndpoint+"upload-signature",null,{params:{policy:t}}).then(function(e){return e.data})},o.upload=function(e,t,o){return n.upload({url:"//v0.api.upyun.com/keylol",data:{file:e,policy:t,signature:o},withCredentials:!1})}}return new o}])}(),function(){"use strict";keylolApp.provider("utils",function(){var e={};return{config:function(t){return t&&(e=t),e},$get:["$q","union","upyun",function(t,n,o){function i(){var o=this,i=1;o.supportWebp=t(function(e,t){var n=new Image;n.onload=function(){n.width>0&&n.height>0?e():t()},n.onerror=function(){t()},n.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA"}),o.byteLength=function(e){for(var t=0,n=e.length-1;n>=0;n--){var o=e.charCodeAt(n);255>=o?t++:o>255&&65535>=o&&(t+=2),o>=56320&&57343>=o&&(n--,t++)}return t},o.createGeetest=function(n,i){"undefined"==typeof window.activateGeetest&&(window.activateGeetest={});var r,a=o.uniqueId(),c=t.defer(),l=t.defer();if(activateGeetest[a]=function(){var t=new Geetest({gt:e.geetestId,product:n,https:"https:"===location.protocol});t.onSuccess(function(){l.resolve(t),r&&r.resolve(t)}),c.resolve(t)},"undefined"==typeof window.Geetest){var s=document.createElement("script");s.src="//api.geetest.com/get.php?callback=activateGeetest["+a+"]",document.body.appendChild(s)}else activateGeetest[a]();return{id:a,ready:c.promise,success:l.promise,refresh:function(){return r=t.defer(),c.promise.then(function(e){e.refresh()}),r.promise}}},o.uniqueId=function(){return i++},o.arrayUnique=function(e){if(0===e.length)return e;e.sort();for(var t=[e[0]],n=1;n<e.length;n++)e[n]!==t[t.length-1]&&t.push(e[n]);return t},o.getPointType=function(e){return"Game"===e?"游戏":"Genre"===e?"类型":"Manufacturer"===e?"厂商":"Platform"===e?"平台":void 0},o.getPointFirstName=function(e){return e[e.PreferredName+"Name"]},o.getPointSecondName=function(e){return"Chinese"===e.PreferredName?e.EnglishName:"English"===e.PreferredName?e.ChineseName:void 0},o.addRecentBroswe=function(e,t,o){n.$localStorage.recentBrowse||(n.$localStorage.recentBrowse=[]);var i=-1;for(var r in n.$localStorage.recentBrowse)n.$localStorage.recentBrowse[r].type===e&&n.$localStorage.recentBrowse[r].idCode===o&&(i=r);for(-1!==i&&n.$localStorage.recentBrowse.splice(i,1),n.$localStorage.recentBrowse.unshift({type:e,idCode:o,name:t});n.$localStorage.recentBrowse.length>5;)n.$localStorage.recentBrowse.pop()},o.modelValidate={steamBindingTokenId:function(e,t,n){return e?!0:(t[n]="SteamBindingTokenId cannot be empty.",!1)},idCode:function(e,t,n){return/^[A-Z0-9]{5}$/.test(e)?!0:(t[n]="Only 5 uppercase letters and digits are allowed in IdCode.",!1)},username:function(e,t,n){var i=o.byteLength(e);return 3>i||i>16?(t[n]="UserName should be 3-16 bytes.",!1):/^[0-9A-Za-z\u4E00-\u9FCC]+$/.test(e)?!0:(t[n]="Only digits, letters and Chinese characters are allowed in UserName.",!1)},password:function(e,t,n){return e.length<6?(t[n]="Passwords must be at least 6 characters.",!1):!0},gamerTag:function(e,t,n){return o.byteLength(e)>40?(t[n]="GamerTag should not be longer than 40 bytes.",!1):!0}},o.modelErrorDetect={steamBindingTokenId:function(e){return/cannot be empty/.test(e)?"empty":"unknown"},idCode:function(e){return/Only.*allowed/.test(e)?"format":/already used/.test(e)?"used":"unknown"},username:function(e){return/should.*bytes/.test(e)?"length":/Only.*allowed/.test(e)?"format":/already.*used/.test(e)?"used":"unknown"},password:function(e){return/least.*characters/.test(e)?"length":/not correct/.test(e)?"incorrect":/cannot be empty/.test(e)?"empty":"unknown"},email:function(e){return/already taken/.test(e)?"used":/is invalid/.test(e)?"malformed":/cannot be empty/.test(e)?"empty":/doesn't exist/.test(e)?"inexistent":/locked out/.test(e)?"lockedout":/Login failed/.test(e)?"failed":"unknown"},gamerTag:function(e){return/not be longer than/.test(e)?"length":"unknown"}},o.escapeHtml=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},o.timelineLoadCount=20,o.timelineShowDelay=150,o.firefoxLinkFix=function(e){if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){var t=window.open($(e.currentTarget).attr("href"),"newwindow","width=300, height=250");t.close(),e.preventDefault()}},o.getVoteColor=function(e){return["terrible","bad","not-bad","good","awesome"][e]}}return new i}]}})}(),function(){"use strict";keylolApp.factory("window",["$compile","$controller","$rootScope","$q","$window","$templateRequest","$timeout","$animate",function(e,t,n,o,i,r,a,c){
function l(){var l,s=this,u=function(){var e=document.createElement("div");e.className="scrollbar-measure",$(document.body).append(e);var t=e.offsetWidth-e.clientWidth;return $(e).remove(),t},d=function(){var e=$(document.body);if(e.find("main[ng-view] > window").length>0){if(!e.hasClass("body-window-open")){l=document.body.style.paddingRight||"";var t=i.innerWidth;if(!t){var n=document.documentElement.getBoundingClientRect();t=n.right-Math.abs(n.left)}if(document.body.clientWidth<t){var o=parseInt(e.css("padding-right")||0,10);e.css("padding-right",o+u()+"px")}e.addClass("body-window-open")}}else e.hasClass("body-window-open")&&(e.css("padding-right",l),e.removeClass("body-window-open"))};s.show=function(i){i=$.extend({adjustScrollBar:!0,global:!1,delayAppend:!1},i);var l=o.defer(),s=i.controller;i.controllerAs&&(s=s+" as "+i.controllerAs);var u=function(r){var u=n.$new(),m=e(r),p=m(u);i.styles&&p.css(i.styles);var f=o.defer(),h=function(e){f.resolve(e),c.leave(p).then(function(){u.$destroy(),i.adjustScrollBar&&d()})},g={$scope:u,$element:p,close:h};i.inputs&&$.extend(g,i.inputs);var v;s&&(v=t(s,g));var y=function(){var e=i.global?document.body:$("main[ng-view]")[0];c.enter(p,e,e.lastChild),i.adjustScrollBar&&d(),l.resolve({controller:v,scope:u,$element:p,close:f.promise,closeNow:h})};i.delayAppend?a(y):y()};return i.template?u(i.template):i.templateUrl&&r(i.templateUrl).then(function(e){u(e)}),l.promise}}return new l}])}(),function(){"use strict";keylolApp.controller("ActionHubController",["$scope","union","window",function(e,t,n){e.union=t,e.showRegistrationWindow=function(){n.show({templateUrl:"components/windows/registration.html",controller:"RegistrationController"})},e.showLoginSteamWindow=function(){n.show({templateUrl:"components/windows/login-steam.html",controller:"LoginSteamController"})},e.showSettingsWindow=function(){n.show({templateUrl:"components/windows/settings.html",controller:"SettingsController"})}}])}(),function(){"use strict";keylolApp.controller("ArticleCommentsController",["$scope","union","$http","utils","getAndFlushComments","notification",function(e,t,n,o,i,r){e.comments=t.comments,e.article=t.article,e.hotComments=t.hotComments,e.user=t.$localStorage.user,e.pageElements=t.pageElements,e.textFocus=!1,e.submitLock=!1,e.doComment=function(){if(e.currentComment){e.submitLock=!0;var o=a(e.currentComment);n.post(apiEndpoint+"comment",{Content:e.currentComment,ArticleId:t.article.Id,ReplyToCommentsSN:o}).then(function(n){r.success("评论已发出"),e.submitLock=!1,e.currentComment="";var o=n.data.SequenceNumberForArticle;i(t.article,o,"sequence")},function(t){r.error("评论发送失败",t),e.submitLock=!1})}},e.reply=function(t){e.currentComment?""==e.currentComment?e.currentComment+="#"+t+" ":e.currentComment+="\n#"+t+" ":e.currentComment="#"+t+" ",e.textFocus=!0},e.acknowledge=function(e){n.post(apiEndpoint+"like",{TargetId:e.Id,Type:"CommentLike"}).then(function(){r.success("认可已生效")},function(e){r.error("认可评论失败",e)}),e.Liked=!0,e.hasLike=!0,e.LikeCount+=1},e.cancelAcknowledge=function(e){n["delete"](apiEndpoint+"like",{params:{targetId:e.Id,type:"CommentLike"}}).then(function(){r.success("此认可已被撤销")},function(e){r.error("取消认可评论失败",e)}),e.Liked=!1,e.LikeCount-=1,e.LikeCount<=0&&(e.hasLike=!1)};var a=function(e){var n=/^((?:#\d+[ \t]*)+)(?:$|[ \t]+)/gm,i=/(\d+)/g,r=e.match(n),a=[];return r&&(a=r.length>1?r.reduce(function(e,t){return"string"==typeof e&&(e=e.match(i)),t=t.match(i),e.concat(t)}):r[0].match(i)),a=o.arrayUnique(a).map(function(e){return parseInt(e)}),a.length>1?a.reduce(function(e,n){return"number"==typeof e&&(e=[e]),n>t.article.totalComments?e:(e.push(n),e)}):1==a.length&&a[0]>t.article.totalComments?[]:a}}])}(),function(){"use strict";keylolApp.controller("ArticleContentController",["$scope","union","$http","notification",function(e,t,n,o){e.article=t.article,e.acknowledge=function(){n.post(apiEndpoint+"like",{TargetId:e.article.Id,Type:"ArticleLike"}).then(function(e){o.success("认可已生效")},function(e){o.error("认可失败",e)}),e.article.Liked=!0,e.article.hasLike=!0,e.article.LikeCount+=1},e.cancelAcknowledge=function(){n["delete"](apiEndpoint+"like",{params:{targetId:e.article.Id,type:"ArticleLike"}}).then(function(e){o.success("此认可已被撤销")},function(e){o.error("取消认可失败",e)}),e.article.Liked=!1,e.article.LikeCount-=1,e.article.LikeCount<=0&&(e.article.hasLike=!1)}}])}(),function(){"use strict";keylolApp.controller("ArticleHeaderController",["$scope","union","window","utils",function(e,t,n,o){e.utils=o,e.article=t.article,e.point=t.point,e.summary=t.summary,e.editArticle=function(){"简评"===e.article.TypeName?n.show({templateUrl:"components/windows/short-review.html",controller:"ShortReviewController",inputs:{options:{point:{Id:e.point.Id,IdCode:e.point.IdCode,CoverImage:e.point.CoverImage,Name:o.getPointFirstName(e.point)},vm:{Id:e.article.Id,Content:e.article.Content,Vote:e.article.Vote},gameHours:790.5}}}):n.show({templateUrl:"components/windows/editor.html",controller:"EditorController",inputs:{options:{vm:{Id:e.article.Id,Title:e.article.Title,Content:e.article.Content,Summary:e.article.Summary,Pros:e.article.Pros,Cons:e.article.Cons,Vote:e.article.Vote,TypeName:e.article.TypeName},attachedPoints:e.article.AttachedPoints,voteForPoint:e.article.VoteForPoint,needConfirmLoadingDraft:!0}}})}}])}(),function(){"use strict";keylolApp.controller("LatestArticlesController",["$scope","$http","apiEndpoint","union",function(e,t,n,o){e.articles=o.$localStorage.latestArticles,t.get(n+"article/latest").then(function(t){o.$localStorage.latestArticles=e.articles=t.data})}])}(),function(){"use strict";keylolApp.controller("MainNavigationController",["$scope","$http","apiEndpoint","utils","union",function(e,t,n,o,i){e.utils=o,e.categories=i.$localStorage.mainNavigation,t.get(n+"normal-point/active-of-each-type").then(function(t){i.$localStorage.mainNavigation=e.categories=t.data})}])}(),function(){"use strict";keylolApp.controller("PointInfoController",["$scope","union","window","utils","notification",function(e,t,n,o,i){e.utils=o,e.point=t.point,e.showShortReviewWindow=function(t){return n.show({templateUrl:"components/windows/short-review.html",controller:"ShortReviewController",inputs:{options:{point:{Id:e.point.Id,IdCode:e.point.IdCode,CoverImage:e.point.CoverImage,Name:o.getPointFirstName(e.point)},vm:{Vote:t},gameHours:790.5}}}),!0},e.showEditorWindow=function(){i.attention("此前尚未发布的草稿会被覆盖",[{action:"覆盖",value:!0},{action:"取消"}]).then(function(t){t&&n.show({templateUrl:"components/windows/editor.html",controller:"EditorController",inputs:{options:{voteForPoint:e.point,vm:{TypeName:"评",Pros:[],Cons:[]},doNotLoadDraft:!0}}})})},e.showRelatedGames=function(n,o,i){e.showRelatedPopup({templateUrl:"components/popup/related-games.html",controller:"RelatedGamesController",event:n,attachSide:"left",align:"top",offsetX:580,offsetY:32,inputs:{idCode:t.point.IdCode,type:o,count:i}})},e.showPointEdit=function(t){n.show({templateUrl:"components/windows/point-settings.html",controller:"PointSettingsController",inputs:{point:e.point,isGame:t,isJustCreated:!1}})}}])}(),function(){"use strict";keylolApp.controller("PointVotesController",["$scope","union","utils",function(e,t,n){e.point=t.point,e.utils=n,e.circles=[new Array(1),new Array(2),new Array(3),new Array(4),new Array(5)]}])}(),function(){"use strict";keylolApp.controller("PromotedReadingsController",["$scope","$http","apiEndpoint","union",function(e,t,n,o){e.articles=o.$localStorage.promotedReadings,t.get(n+"article/hot").then(function(t){o.$localStorage.promotedReadings=e.articles=t.data})}])}(),function(){"use strict";keylolApp.controller("ReceptionController",["$scope","$http","notification","union","$routeParams","utils",function(e,t,n,o,i,r){e.quickLinks=[],e.recentLinks=[],$.extend(e.recentLinks,o.$localStorage.recentBrowse);var a=function(t){$.extend(e.quickLinks,t),e.canBeAdd=e.quickLinks.length<5;for(var n in e.quickLinks)switch(e.quickLinks[n].Type){case"Unknown":break;case"NormalPoint":i.pointIdCode===e.quickLinks[n].IdCode&&(e.canBeAdd=!1);break;case"ProfilePoint":i.userIdCode===e.quickLinks[n].IdCode&&(e.canBeAdd=!1)}};o.$localStorage.favorites&&a(o.$localStorage.favorites),t.get(apiEndpoint+"favorite").then(function(e){o.$localStorage.favorites=e.data,a(e.data)},function(e){n.error("未知错误",e)}),e.deleteFavorite=function(o){var r=e.quickLinks[o];t["delete"](apiEndpoint+"favorite/"+r.Id).then(function(){"Unknown"===r.Type||i.pointIdCode!==r.IdCode&&i.userIdCode!==r.IdCode||(e.canBeAdd=!0)},function(e){n.error("未知错误",e)}),e.quickLinks.splice(o,1)},e.addFavorite=function(){i.pointIdCode&&o.point.Id?(e.canBeAdd=!1,t.post(apiEndpoint+"favorite",{},{params:{pointId:o.point.Id}}).then(function(t){e.quickLinks.push({Id:t.data,Type:"NormalPoint",IdCode:o.point.IdCode,Name:r.getPointFirstName(o.point)})},function(t){n.error("未知错误",t),e.canBeAdd=!0})):i.userIdCode&&o.user.Id&&(e.canBeAdd=!1,t.post(apiEndpoint+"favorite",{},{params:{pointId:o.user.Id}}).then(function(t){e.quickLinks.push({Id:t.data,Type:"ProfilePoint",IdCode:o.user.IdCode,Name:o.user.UserName})},function(t){n.error("未知错误",t),e.canBeAdd=!0}))},e.deleteRecentBroswe=function(){o.$localStorage.recentBrowse=[],e.recentLinks=[]}}])}(),function(){"use strict";keylolApp.controller("RelatedPointsController",["$scope","union","utils",function(e,t,n){e.union=t,e.utils=n}])}(),function(){"use strict";keylolApp.controller("SearchBoxController",["$scope","union","$timeout","$location",function(e,t,n,o){e.onSearching=function(){var n="";for(var i in t.searchFilter)t.searchFilter[i].active&&(n=t.searchFilter[i].type);e.searchText&&o.url("search/"+n+"/"+encodeURIComponent(e.searchText))};var i=!1,r={onSearching:e.onSearching},a=function(t){i=!0,e.showSearchSelector({templateUrl:"components/popup/search-selector.html",controller:"SearchSelectorController",attachSide:"bottom",event:t,align:"right",inputs:{options:r}}).then(function(e){return e.close}).then(function(){i=!1})};e.getSearchResults=function(t){var n="";void 0!==e.searchText&&(n=e.searchText),r.searchText=n,i||a($.extend(t,{type:"click",acceptCurrentTarget:!0}))},e.$watch("searchText",function(){e.delayGetResult&&n.cancel(e.delayGetResult),void 0!==e.searchText&&(e.delayGetResult=n(function(){r.searchText=e.searchText},200))}),t.searchFilter=[{type:"point",text:"据点",active:!0},{type:"article",text:"文章"},{type:"user",text:"用户"}]}])}(),function(){"use strict";keylolApp.controller("SecretTestsController",["$scope","window",function(e,t){e.showCreatePointWindow=function(){t.show({templateUrl:"components/windows/create-point.html",controller:"CreatePointController",inputs:{vm:null}})},e.showPointListWindow=function(){t.show({templateUrl:"components/windows/point-list.html",controller:"PointListController"})}}])}(),function(){"use strict";keylolApp.controller("SummaryController",["$scope","union","$http","notification",function(e,t,n,o){e.data=t.summary,e.subscribeDisabled=!1,e.subscribe=function(i){e.subscribeDisabled=!0,n.post(apiEndpoint+"user-point-subscription",{},{params:{pointId:i}}).then(function(){o.success("据点已订阅，其今后收到的文章投稿将推送到你的首页"),e.data.subscribed=!0,e.subscribeDisabled=!1,e.data.pointSum.readerNum++,t.$localStorage.user.SubscribedPointCount++},function(e){o.error("未知错误",e)})},e.unsubscribe=function(i){e.subscribeDisabled=!0,o.attention("退订并不再接收此据点的文章推送",[{action:"退订",value:!0},{action:"取消"}]).then(function(r){r?n["delete"](apiEndpoint+"user-point-subscription",{params:{pointId:i}}).then(function(){o.success("据点已退订"),e.data.subscribed=!1,e.data.pointSum.readerNum--,t.$localStorage.user.SubscribedPointCount--},function(e){o.error("未知错误",e)})["finally"](function(){e.subscribeDisabled=!1}):e.subscribeDisabled=!1})}}])}(),function(){"use strict";keylolApp.controller("TimelineController",["$scope","union","$location","$http","$rootScope","$element","articleTypes","notification","utils","$timeout",function(e,t,n,o,i,r,a,c,l,s){function u(n){e.data.loadingLock=!0;for(var o="",i=0,r=0;r<a.length;r++)m[r]&&(i++,0!==o.length&&(o+=","),o+=a[r].name);if(o){var c=2147483647;n&&(c=e.data.entries[e.data.entries.length-1].sequenceNumber),5===i&&(o=void 0),e.data.loadAction({idType:"IdCode",articleTypeFilter:o,publishOnly:e.data.publishOnly,take:l.timelineLoadCount,beforeSN:c},function(o){var i=o.data;n||(e.data.entries.length=0),e.data.noMoreArticle=i.length<l.timelineLoadCount;var r;for(var a in i){var c=i[a];c.Author||(c.Author=t.user);var u={types:[c.TypeName],author:{username:c.Author.UserName,avatarUrl:c.Author.AvatarImage,idCode:c.Author.IdCode},sequenceNumber:c.SequenceNumber,sources:{},voteForPoint:c.VoteForPoint,datetime:c.PublishTime,title:c.Title,summary:c.Content,hasBackground:!1,vote:c.Vote,voteColor:c.Vote?l.getVoteColor(c.Vote-1):null,thumbnail:c.ThumbnailImage,hasThumbnail:!0,url:"/article/"+c.Author.IdCode+"/"+c.SequenceNumberForAuthor,count:{like:c.LikeCount,comment:c.CommentCount}};switch(c.TimelineReason){case"Like":if(u.sources.type="like",u.sources.userArray=[],c.LikeByUsers)for(var d in c.LikeByUsers)u.sources.userArray.push({name:c.LikeByUsers[d].UserName,idCode:c.LikeByUsers[d].IdCode});else u.sources.userArray.push({name:t.$localStorage.user.UserName,idCode:t.$localStorage.user.IdCode});break;case"Point":c.AttachedPoints?(u.sources.type="point",u.sources.points=c.AttachedPoints):u.sources=null;break;case"Publish":u.sources.type="publish"}e.data.entries.push(u),function(e){s(function(){r?r=r.then(function(){return e.show=!0,s(function(){},l.timelineShowDelay)}):(e.show=!0,r=s(function(){},l.timelineShowDelay))})}(u)}r?r.then(function(){e.data.loadingLock=!1}):e.data.loadingLock=!1})}else e.data.entries.length=0,e.data.noMoreArticle=!0}e.headingDisplayMode=function(e){return e.source?"source":"title"},e.data=t.timeline,e.utils=l,e.clickToSearch=function(){var e=$(".search-box input");e.focus(),e.hasClass("highlight")&&e.removeClass("highlight"),e.addClass("highlight")},e.circles=function(e){return new Array(e)},e.clickTheBox=function(e){n.url(e.url)},e.ignore=function(t){e.data.entries.splice(e.data.entries.indexOf(t),1),o.put(apiEndpoint+"like/"+t.id,{},{params:{ignore:!0}}).then(function(){c.success("移除记录成功")},function(e){c.error("移除记录失败",e)})},e.noMoreRemind=function(e){e.commentId?o.put(apiEndpoint+"comment/"+e.commentId+"/ignore",{},{params:{ignore:!0}}).then(function(){c.success("评论认可不再提醒成功")},function(e){c.error("评论认可不再提醒失败",e)}):o.put(apiEndpoint+"article/"+e.fromArticle.id+"/ignore",{},{params:{ignore:!0}}).then(function(){c.success("文章认可不再提醒成功")},function(e){c.error("文章认可不再提醒失败",e)})},e.loadingLock=!1,$(window).scroll(function(){var t=$(window).scrollTop()+$(window).height(),n=r.offset().top+r.height();e.$apply(function(){t>n-60&&!e.data.loadingLock&&!e.data.noMoreArticle&&(e.data.hasExpand?u(!0):e.data.loadAction())})});var d=e.$on("$destroy",function(){$(window).unbind("scroll"),d()});e.expanded=!1;for(var m=[],p=0;p<a.length;++p)m.push(!0);e.expand=function(t){e.expanded=!e.expanded,e.showFilter({templateUrl:"components/popup/entry-filter.html",controller:"EntryFilterController",event:t,attachSide:"bottom",align:"right",offsetX:5,inputs:{types:a,selectedIndexes:m}}).then(function(e){return e.close}).then(function(t){e.expanded=!e.expanded,t&&(m=t,u())})},e.filterText=function(){for(var e=[],t=[],n=0;n<m.length;n++)m[n]?e.push(n):t.push(n);var o;if(e.length==a.length)o="全部";else if(e.length>=Math.floor(a.length/2)+1){o="不看";for(var i in t)o+="『"+a[t[i]].name+"』"}else if(t.length==a.length)o="全部不看";else{o="只看";for(var r in e)o+="『"+a[e[r]].name+"』"}return o},e.subscribe=function(e){e.subscribeDisabled=!0,o.post(apiEndpoint+"user-point-subscription",{},{params:{pointId:e.id}}).then(function(){c.success("据点已订阅，其今后收到的文章投稿将推送到你的首页"),e.subscribed=!0,e.subscribeDisabled=!1,e.pointInfo.reader++,t.$localStorage.user.SubscribedPointCount++},function(e){c.error("未知错误",e)})},e.unsubscribe=function(n){n.subscribeDisabled=!0,c.attention("退订并不再接收此据点的文章推送",[{action:"退订",value:!0},{action:"取消"}]).then(function(i){i?o["delete"](apiEndpoint+"user-point-subscription",{params:{pointId:n.id}}).then(function(){c.success("据点已退订"),n.subscribed=!1,n.pointInfo.reader--,t.$localStorage.user.SubscribedPointCount--},function(e){c.error("未知错误",e)})["finally"](function(){e.subscribeDisabled=!1}):n.subscribeDisabled=!1})}}])}(),function(e,t,n){"use strict";function o(t,n){return function(){n.apply(t,e.makeArray(arguments))}}function i(t,n){var i,r,a,c,l;for(i in t)if(t.hasOwnProperty(i)){if(r=t[i],!r.hubName)continue;l=n?r.on:r.off;for(a in r.client)if(r.client.hasOwnProperty(a)){if(c=r.client[a],!e.isFunction(c))continue;l.call(r,a,o(r,c))}}}if("function"!=typeof e.signalR)throw new Error("SignalR: SignalR is not loaded. Please ensure jquery.signalR-x.js is referenced before ~/signalr/js.");var r=e.signalR;e.hubConnection.prototype.createHubProxies=function(){var t={};return this.starting(function(){i(t,!0),this._registerSubscribedHubs()}).disconnected(function(){i(t,!1)}),t.debugInfoHub=this.createHubProxy("debugInfoHub"),t.debugInfoHub.client={},t.debugInfoHub.server={},t.steamBindingHub=this.createHubProxy("steamBindingHub"),t.steamBindingHub.client={},t.steamBindingHub.server={createToken:function(){return t.steamBindingHub.invoke.apply(t.steamBindingHub,e.merge(["CreateToken"],e.makeArray(arguments)))}},t.steamLoginHub=this.createHubProxy("steamLoginHub"),t.steamLoginHub.client={},t.steamLoginHub.server={createToken:function(){return t.steamLoginHub.invoke.apply(t.steamLoginHub,e.merge(["CreateToken"],e.makeArray(arguments)))}},t},r["new"]=function(){var n=e.hubConnection(t.apiEndpoint+"signalr",{useDefaultPath:!1});e.extend(n,n.createHubProxies());var o=n.start;return n.start=function(t,n){var i={pingInterval:3e5,waitForPageLoad:!1,transport:"auto",jsonp:!1};return o.call(this,e.extend(i,t),n)},n}}(window.jQuery,window),function(){"use strict";keylolApp.controller("AlphaInvitationController",["$scope","close","window","$http","apiEndpoint","notification","union",function(e,t,n,o,i,r,a){e.vm={InvitationCode:""},e.cancel=function(){t()},e.switchToLoginWindow=function(){n.show({templateUrl:"components/windows/login-steam.html",controller:"LoginSteamController"}),t()},e.getInvitationCode=function(){t(),$("body").animate({scrollTop:$("#get-invitation-code").offset().top},3e3)},e.submitLock=!1,e.submit=function(){return e.submitLock?void 0:(e.submitLock=!0,e.invitationCodeError=null,e.vm.InvitationCode?void o.get(i+"invitation-code/"+e.vm.InvitationCode).then(function(){a.invitationCode=e.vm.InvitationCode,n.show({templateUrl:"components/windows/registration.html",controller:"RegistrationController"}),t()},function(t){404===t.status?e.invitationCodeError="invalid":r.error("未知错误",t),e.submitLock=!1}):(e.invitationCodeError="empty",void(e.submitLock=!1)))}}])}(),function(){"use strict";keylolApp.controller("ConfirmationController",["$scope","close","window","apiEndpoint","utils","notification","point","$location","union",function(e,t,n,o,i,r,a,c,l){e.utils=i,e.cancel=function(){t()},e.submit=function(){t(),l.inEditor?r.success("「据点已开设，可以随时接收文章投稿」"):(c.url("point/"+a.IdCode),r.success("「据点已开设」"))},e.switchToEditInfo=function(){n.show({templateUrl:"components/windows/point-settings.html",controller:"PointSettingsController",inputs:{point:a,isGame:!0,isJustCreated:!0}}),t()},e.point=a}])}(),function(){"use strict";keylolApp.controller("CreatePointController",["$scope","close","$http","apiEndpoint","utils","notification","vm",function(e,t,n,o,i,r,a){e.radioId=[];for(var c=0;6>c;++c)e.radioId.push(i.uniqueId());var l=function(){a?(e.vm=$.extend({},a),e.inline={avatarImageFull:a.AvatarImage,backgroundImageFull:a.BackgroundImage,associatedPoints:a.AssociatedPoints}):(e.vm={Type:"Game",ChineseName:"",EnglishName:"",PreferredName:"Chinese",ChineseAliases:"",EnglishAliases:"",IdCode:"",StoreLink:""},e.inline={avatarImageFull:"",backgroundImageFull:"",associatedPoints:[]})};l(),e.cancel=function(){t()},e.$watchCollection("inline.associatedPoints",function(t){if(e.vm.AssociatedPointsId=[],t)for(var n=0;n<t.length;++n)e.vm.AssociatedPointsId.push(t[n].Id)});var s=!1;e.submit=function(){if(!s){s=!0;var i=/^(?:http:|https:)?\/\/storage\.keylol\.com\/(.*?)(?:!.*)?$/i,c=e.inline.avatarImageFull.match(i);e.vm.AvatarImage=c?"keylol://"+c[1]:e.inline.avatarImageFull;var u=e.inline.backgroundImageFull.match(i);if(e.vm.BackgroundImage=u?"keylol://"+u[1]:e.inline.backgroundImageFull,"Game"===e.vm.Type&&!/^http:\/\/store\.steampowered\.com\/app\/(\d+)\//i.test(e.vm.StoreLink))return r.error("商店链接输入有误，请检查"),void(s=!1);e.vm.IdCode=e.vm.IdCode.toUpperCase(),a?n.put(o+"normal-point/"+e.vm.Id,e.vm).then(function(){r.success("据点编辑成功"),$.extend(a,e.vm),t()},function(e){400===e.status?r.error(e.data):404===e.status&&r.error("指定据点不存在"),s=!1}):n.post(o+"normal-point",e.vm).then(function(){r.success("据点创建成功"),s=!1,l()},function(e){400===e.status?r.error(e.data):r.error("未知错误",e),s=!1})}}}])}(),function(){"use strict";keylolApp.controller("EditorController",["$scope","close","utils","$http","union","$timeout","$location","notification","options","articleTypes","$route","$element",function(e,t,n,o,i,r,a,c,l,s,u,d){i.inEditor=!0,e.editorOptions={scrollableContainer:d},e.articleTypes=s,e.expanded=!1,e.lastSaveTime=null,e.inline={},e.selectedTypeIndex=0;var m=3e4,p=n.uniqueId();$(window).on("beforeunload.editor"+p,function(){return"未保存的内容将被弃置。"}),e.$on("$destroy",function(){$(window).off("beforeunload.editor"+p)});var f=e.$on("$locationChangeStart",function(e){confirm("未保存的内容将被弃置，确认离开？")?(f(),$(window).off("beforeunload.editor"+p)):e.preventDefault()});l=$.extend({vm:null,needConfirmLoadingDraft:!1},l);var h,g=function(){if(e.vm=$.extend({Title:"",Content:"",Summary:"",Pros:[],Cons:[],Vote:null},l.vm),e.vm.TypeName)for(var t=0;t<s.length;++t)if(s[t].name===e.vm.TypeName){e.selectedTypeIndex=t;break}l.attachedPoints&&(e.inline.attachedPoints=l.attachedPoints),l.voteForPoint&&(e.vm.VoteForPointId=l.voteForPoint.Id,e.inline.voteForPoints=[l.voteForPoint])};e.saveDraft=function(){r.cancel(h),e.lastSaveTime=moment(),i.$localStorage.editorDrafts[v]={vm:e.vm,time:e.lastSaveTime,selectedTypeIndex:e.selectedTypeIndex,attachedPoints:e.inline.attachedPoints,voteForPoints:e.inline.voteForPoints},h=r(e.saveDraft,m)},i.$localStorage.editorDrafts||(i.$localStorage.editorDrafts={});var v=l.vm?l.vm.Id:"new",y=i.$localStorage.editorDrafts[v];if(y){var C=function(){e.vm=y.vm,e.lastSaveTime=y.time,s[y.selectedTypeIndex].allowVote?e.inline.voteForPoints=y.voteForPoints:e.inline.attachedPoints=y.attachedPoints,e.selectedTypeIndex=y.selectedTypeIndex,c.success("本地草稿已加载")};l.needConfirmLoadingDraft?(g(),c.attention("直接编辑上次未完成的草稿",[{action:"加载草稿",value:!0},{action:"取消"}]).then(function(t){t&&C(),h=r(e.saveDraft,m)})):l.doNotLoadDraft?(g(),h=r(e.saveDraft,m)):(C(),h=r(e.saveDraft,m))}else g(),h=r(e.saveDraft,m);var k=function(){e.inline.attachedPoints=[],e.vm.VoteForPointId&&o.get(apiEndpoint+"/normal-point/"+e.vm.VoteForPointId+"/related").then(function(t){e.inline.attachedPoints=t.data},function(e){c.error("获取关联据点错误",e)})};e.$watchCollection("inline.attachedPoints",function(t){if(e.vm.AttachedPointsId=[],t)for(var n=0;n<t.length;++n)e.vm.AttachedPointsId.push(t[n].Id)}),e.$watchCollection("inline.voteForPoints",function(t){e.vm.VoteForPointId=null,t&&t.length>0&&(e.vm.VoteForPointId=t[0].Id),"评"===e.vm.TypeName&&k()}),e.$watch("selectedTypeIndex",function(t,n){e.vm.TypeName=s[t].name,s[t].allowVote&&!s[n].allowVote&&k()}),e.expand=function(t){e.expanded=!e.expanded,e.inline.showSelector({templateUrl:"components/popup/article-type-selector.html",controller:"ArticleTypeSelectorController",event:t,attachSide:"bottom",align:"left",offsetX:-6,inputs:{selectedIndex:e.selectedTypeIndex}}).then(function(e){return e.close}).then(function(t){e.expanded=!e.expanded,angular.isUndefined(t)||(e.selectedTypeIndex=t)})},e.cancel=function(){c.attention("关闭文章编辑器需要额外确认",[{action:"关闭",value:!0},{action:"取消"}]).then(function(e){e&&(r.cancel(h),i.inEditor=!1,t())})};var b=function(){if(!e.vm.Title)return"标题";if(!e.vm.Content)return"内容";if(s[e.selectedTypeIndex].allowVote){if(!e.vm.Vote)return"评分";if(!e.vm.VoteForPointId)return"评价的游戏"}return null};e.submitLock=!1,e.submit=function(){if(!e.submitLock){e.submitLock=!0;var n=b();n?(c.error(n+"不能为空"),e.submitLock=!1):e.vm.Id?o.put(apiEndpoint+"article/"+e.vm.Id,e.vm).then(function(){delete i.$localStorage.editorDrafts[v],r.cancel(h),i.inEditor=!1,t(),f(),u.reload(),c.success("文章已发布")},function(t){c.error("未知错误, 请尝试再次发布",t),e.submitLock=!1}):o.post(apiEndpoint+"article",e.vm).then(function(e){delete i.$localStorage.editorDrafts[v],r.cancel(h),i.inEditor=!1,t(),f(),a.url("article/"+i.$localStorage.user.IdCode+"/"+e.data.SequenceNumberForAuthor),c.success("文章已发布")},function(t){c.error("未知错误, 请尝试再次发布",t),e.submitLock=!1})}}}])}(),function(){"use strict";keylolApp.controller("LoginPasswordController",["$scope","close","$http","utils","union","apiEndpoint","window","notification","$element","$timeout",function(e,t,n,o,i,r,a,c,l,s){e.error={},e.errorDetect=o.modelErrorDetect,e.vm={EmailOrIdCode:"",Password:"",GeetestChallenge:"",GeetestSeccode:"",GeetestValidate:""};var u,d=o.createGeetest("float");e.geetestId=d.id,d.ready.then(function(e){s(function(){var t=$("#geetest-"+d.id,l);e.appendTo(t)})});var m=function(t){u=t.getValidate(),e.vm.GeetestChallenge=u.geetest_challenge,e.vm.GeetestSeccode=u.geetest_seccode,e.vm.GeetestValidate=u.geetest_validate};d.success.then(m),e.cancel=function(){t()},e.switchToLoginSteamWindow=function(){a.show({templateUrl:"components/windows/login-steam.html",controller:"LoginSteamController"}),t()},e.submitLock=!1,e.submit=function(){return e.submitLock?void 0:(e.submitLock=!0,e.error={},e.vm.EmailOrIdCode||(e.error["vm.EmailOrIdCode"]="Email or UIC cannot be empty."),e.vm.Password||(e.error["vm.Password"]="Password cannot be empty."),u||(e.error.authCode=!0),$.isEmptyObject(e.error)?void n.post(r+"login",e.vm).then(function(e){i.$localStorage.login=e.data,c.success("登录成功，欢迎回到其乐"),t()},function(t){switch(t.status){case 400:e.error=t.data.ModelState,u=null,d.refresh().then(m);break;default:c.error("未知错误",t)}e.submitLock=!1}):void(e.submitLock=!1))}}])}(),function(){"use strict";keylolApp.controller("LoginSteamController",["$scope","close","$http","apiEndpoint","window","union","$timeout","notification","utils",function(e,t,n,o,i,r,a,c,l){var s,u=$.connection["new"](),d=u.steamLoginHub;e.currentStation=0,e.utils=l,e.cancel=function(){t(),u.stop()},e.switchToLoginPasswordWindow=function(){i.show({templateUrl:"components/windows/login-password.html",controller:"LoginPasswordController"}),e.cancel()},d.client.NotifyCodeReceived=function(){e.$apply(function(){e.currentStation=1,n.post(o+"login/token/"+s,null).then(function(n){e.currentStation=2,r.$localStorage.login=n.data,u.stop(),a(function(){c.success("登录成功，欢迎回到其乐"),t()},1500)},function(e){c.error("未知错误",e)})})},u.start().then(function(){d.server.createToken().then(function(t){e.$apply(function(){s=t.Id,e.code=t.Code})})},function(){c.error("连接失败"),e.cancel()})}])}(),function(){"use strict";keylolApp.controller("PointListController",["$scope","close","$http","apiEndpoint","notification","window",function(e,t,n,o,i,r){e.cancel=function(){t()},e.inline={onPageChange:function(t){var r=20;n.get(o+"normal-point/list",{params:{skip:r*(t-1),take:r}}).then(function(n){e.inline.totalPages=Math.ceil(n.headers("X-Total-Record-Count")/r),e.inline.currentPage=t,e.points=n.data},function(e){i.error("未知错误",e)})},editPoint:function(e){r.show({templateUrl:"components/windows/create-point.html",controller:"CreatePointController",inputs:{vm:e}})}},e.inline.onPageChange(1)}])}(),function(){"use strict";keylolApp.controller("PointSettingsController",["$scope","close","utils","$http","apiEndpoint","base64","upyun","$q","notification","$timeout","point","isGame","isJustCreated","$filter","$location","union","$route",function(e,t,n,o,i,r,a,c,l,s,u,d,m,p,f,h,g){e.page="basic",e.uniqueIds={},e.isGame=d;for(var v=0;2>v;++v)e.uniqueIds[v]=n.uniqueId();e.files={};var y={};if(d?e.vm={ChineseName:u.ChineseName,DisplayAliases:u.DisplayAliases,EnglishAliases:u.EnglishAliases,ChineseAliases:u.ChineseAliases,Description:u.Description,DeveloperPointsId:[],PublisherPointsId:[],GenrePointsId:[],TagPointsId:[],MajorPlatformPointsId:[],MinorPlatformPointsId:[],SeriesPointsId:[],AvatarImage:u.AvatarImage,BackgroundImage:u.BackgroundImage,CoverImage:u.CoverImage}:e.vm={ChineseName:u.ChineseName,EnglishAliases:u.EnglishAliases,ChineseAliases:u.ChineseAliases,Description:u.Description,AvatarImage:u.AvatarImage,BackgroundImage:u.BackgroundImage},"operator"===h.$localStorage.user.StaffClaim?(e.isOperator=!0,e.vm.EnglishName=u.EnglishName,d&&(e.vm.ReleaseDate=p("date")(u.ReleaseDate,"yyyy-MM-dd")),e.vm.IdCode=u.IdCode,e.vm.NameInSteamStore=u.NameInSteamStore,e.vm.PreferredName=u.PreferredName):e.point=u,$.extend(y,e.vm),d){e.inline={DeveloperPoints:u.DeveloperPoints,PublisherPoints:u.PublisherPoints,GenrePoints:u.GenrePoints,TagPoints:u.TagPoints,MajorPlatformPoints:u.MajorPlatformPoints,MinorPlatformPoints:u.MinorPlatformPoints,SeriesPoints:u.SeriesPoints};for(var C in e.inline)if(e.inline.hasOwnProperty(C)){!function(t){e.$watchCollection("inline."+t,function(n){if(e.vm[t+"Id"]=[],n)for(var o=0;o<n.length;++o)e.vm[t+"Id"].push(n[o].Id)})}(C);var k=e.inline[C];y[C+"Id"]=[];for(var b=0;b<k.length;++b)y[C+"Id"].push(k[b].Id)}}var w=function(t){if("object"!=typeof e.vm[t])return e.vm[t]!==y[t];for(var n in e.vm[t])if(e.vm[t][n]!==y[t][n])return!0;return!1};e.cancel=function(){t()},e.setPage=function(t){e.page=t},e.optionsInPageChanged=function(e){var t=[];switch(e){case"basic":t=["EnglishName","ChineseName","DisplayAliases","EnglishAliases","ChineseAliases","Description","ReleaseDate"];break;case"relationship":t=["DeveloperPointsId","PublisherPointsId","GenrePointsId","TagPointsId","MajorPlatformPointsId","MinorPlatformPointsId","SeriesPointsId"];break;case"images":t=["AvatarImage","BackgroundImage","CoverImage"];break;case"preferences":t=["IdCode","NameInSteamStore","PreferredName"]}return t.some(function(e){return w(e)})},e.submitLock=!1,e.submit=function(){if(!e.submitLock){e.submitLock=!0,e.vm.IdCode&&(e.vm.IdCode=e.vm.IdCode.toUpperCase());var n=function(){o.put(i+"normal-point/"+u.Id,e.vm).then(function(){if(d&&m?h.inEditor?l.success("「据点已开设，可以随时接收文章投稿」"):l.success("「据点已开设」"):l.success("「据点信息已更新」"),t(),!h.inEditor){var n=e.vm.IdCode||u.IdCode;f.url()==="/point/"+n?g.reload():f.url("point/"+n)}},function(t){l.error("未知错误",t),e.submitLock=!1})};if(e.files.avatarImage||e.files.backgroundImage||e.files.coverImage){l.process("图像正在上传");var r=a.policy();a.signature(r).then(function(t){var o={};e.files.avatarImage&&(o.avatarImage=a.upload(e.files.avatarImage,r,t),o.avatarImage.then(function(t){e.vm.AvatarImage="keylol://"+t.data.url,e.files.avatarImage=null},function(){l.error("据点图标上传失败"),e.submitLock=!1})),e.files.backgroundImage&&(o.backgroundImage=a.upload(e.files.backgroundImage,r,t),o.backgroundImage.then(function(t){e.vm.BackgroundImage="keylol://"+t.data.url,e.files.backgroundImage=null},function(){l.error("据点大图上传失败"),e.submitLock=!1})),e.files.coverImage&&(o.coverImage=a.upload(e.files.coverImage,r,t),o.coverImage.then(function(t){e.vm.CoverImage="keylol://"+t.data.url,e.files.coverImage=null},function(){l.error("据点封面上传失败"),e.submitLock=!1})),c.all(o).then(function(){n()})},function(){l.error("文件上传验证失效"),e.submitLock=!1})}else n()}}}])}(),function(){"use strict";keylolApp.controller("RegistrationController",["$scope","close","$http","utils","union","apiEndpoint","window","notification","$element","$timeout",function(e,t,n,o,i,r,a,c,l,s){e.vm={IdCode:"",UserName:"",Password:"",SteamBindingTokenId:"",AvatarImage:"",SteamProfileName:"",GeetestChallenge:"",GeetestSeccode:"",GeetestValidate:"",InvitationCode:i.invitationCode};var u,d,m=o.createGeetest("float");e.geetestId=m.id,m.ready.then(function(e){s(function(){var t=$("#geetest-"+m.id,l);e.appendTo(t);
})});var p=function(t){d=t.getValidate(),e.vm.GeetestChallenge=d.geetest_challenge,e.vm.GeetestSeccode=d.geetest_seccode,e.vm.GeetestValidate=d.geetest_validate};m.success.then(p),e.error={},e.errorDetect=o.modelErrorDetect,e.cancel=function(){t(),u&&u.resolve()},e.showSteamConnectWindow=function(){a.show({templateUrl:"components/windows/steam-connect.html",controller:"SteamConnectController"}).then(function(t){t.close.then(function(t){t?(u=t.consume,e.vm.SteamBindingTokenId=t.tokenId,e.vm.SteamProfileName=t.steamProfileName,e.vm.AvatarImage="keylol://steam/avatars/"+t.steamAvatarHash):e.vm.SteamBindingTokenId=""})})},e.discardBinding=function(){e.vm.SteamBindingTokenId="",u&&u.resolve()},e.submitLock=!1,e.submit=function(){return e.submitLock?void 0:(e.submitLock=!0,e.error={},e.vm.IdCode=e.vm.IdCode.toUpperCase(),o.modelValidate.steamBindingTokenId(e.vm.SteamBindingTokenId,e.error,"vm.SteamBindingTokenId"),o.modelValidate.idCode(e.vm.IdCode,e.error,"vm.IdCode"),o.modelValidate.username(e.vm.UserName,e.error,"vm.UserName"),o.modelValidate.password(e.vm.Password,e.error,"vm.Password"),d||(e.error.authCode=!0),$.isEmptyObject(e.error)?void n.post(r+"user",e.vm).then(function(e){i.$localStorage.login=e.data,t(),u&&u.resolve()},function(t){switch(t.status){case 400:e.error=t.data.ModelState,d=null,m.refresh().then(p);break;default:c.error("未知错误",t)}e.submitLock=!1}):void(e.submitLock=!1))}}])}(),function(){"use strict";keylolApp.controller("SettingsController",["$scope","close","utils","$http","union","apiEndpoint","base64","Upload","$q","notification","$element","$timeout","upyun",function(e,t,n,o,i,r,a,c,l,s,u,d,m){e.error={},e.errorDetect=n.modelErrorDetect,e.page="profiles",e.uniqueIds={};for(var p=0;22>p;++p)e.uniqueIds[p]=n.uniqueId();e.union=i,e.files={},e.vm={ProfilePointBackgroundImage:"",Password:"",NewPassword:"",ConfirmPassword:""};var f={},h=function(t){$.extend(e.vm,{GamerTag:t.GamerTag,AvatarImage:t.AvatarImage,Email:t.Email,ProfilePointBackgroundImage:t.ProfilePointBackgroundImage,AutoShareOnAcquiringNewGame:t.AutoShareOnAcquiringNewGame,AutoShareOnAddingFavorite:t.AutoShareOnAddingFavorite,AutoShareOnAddingNewFriend:t.AutoShareOnAddingNewFriend,AutoShareOnAddingVideo:t.AutoShareOnAddingVideo,AutoShareOnCreatingGroup:t.AutoShareOnCreatingGroup,AutoShareOnJoiningGroup:t.AutoShareOnJoiningGroup,AutoShareOnPublishingReview:t.AutoShareOnPublishingReview,AutoShareOnUnlockingAchievement:t.AutoShareOnUnlockingAchievement,AutoShareOnUpdatingWishlist:t.AutoShareOnUpdatingWishlist,AutoShareOnUploadingScreenshot:t.AutoShareOnUploadingScreenshot,LockoutEnabled:t.LockoutEnabled,EmailNotifyOnAdvertisement:t.EmailNotifyOnAdvertisement,EmailNotifyOnArticleReplied:t.EmailNotifyOnArticleReplied,EmailNotifyOnCommentReplied:t.EmailNotifyOnCommentReplied,EmailNotifyOnEditorRecommended:t.EmailNotifyOnEditorRecommended,EmailNotifyOnMessageReceived:t.EmailNotifyOnMessageReceived,MessageNotifyOnArticleLiked:t.MessageNotifyOnArticleLiked,MessageNotifyOnArticleReplied:t.MessageNotifyOnArticleReplied,MessageNotifyOnCommentLiked:t.MessageNotifyOnCommentLiked,MessageNotifyOnCommentReplied:t.MessageNotifyOnCommentReplied,MessageNotifyOnEditorRecommended:t.MessageNotifyOnEditorRecommended,SteamId:t.SteamId,SteamId64:t.SteamId64,SteamProfileName:t.SteamProfileName,StatusClaim:t.StatusClaim,StaffClaim:t.StaffClaim}),$.extend(f,e.vm)},g=function(t){return e.vm[t]!==f[t]};h(i.$localStorage.user),o.get(r+"user/"+i.$localStorage.login.UserId,{params:{includeClaims:!0,includeSecurity:!0,includeProfilePointBackgroundImage:!0,includeSteam:!0,includeSteamBot:!0,includeMoreOptions:!0}}).then(function(e){var t=e.data;h(t),$.extend(i.$localStorage.user,t)});var v,y=n.createGeetest("float");e.geetestId=y.id,y.ready.then(function(e){d(function(){var t=$("#geetest-"+y.id,u);e.appendTo(t)})});var C=function(t){v=t.getValidate(),e.vm.GeetestChallenge=v.geetest_challenge,e.vm.GeetestSeccode=v.geetest_seccode,e.vm.GeetestValidate=v.geetest_validate};y.success.then(C),e.cancel=function(){t()},e.setPage=function(t){e.page=t},e.optionsInPageChanged=function(e){var t=[];switch(e){case"profiles":t=["GamerTag","Email","AvatarImage","ProfilePointBackgroundImage"];break;case"platform":t=["AutoShareOnAcquiringNewGame","AutoShareOnAddingFavorite","AutoShareOnAddingNewFriend","AutoShareOnAddingVideo","AutoShareOnCreatingGroup","AutoShareOnJoiningGroup","AutoShareOnPublishingReview","AutoShareOnUnlockingAchievement","AutoShareOnUpdatingWishlist","AutoShareOnUploadingScreenshot"];break;case"security":t=["LockoutEnabled","EmailNotifyOnAdvertisement","EmailNotifyOnArticleReplied","EmailNotifyOnCommentReplied","EmailNotifyOnEditorRecommended","EmailNotifyOnMessageReceived","NewPassword"];break;case"preferences":t=["EmailNotifyOnAdvertisement","EmailNotifyOnArticleReplied","EmailNotifyOnCommentReplied","EmailNotifyOnEditorRecommended","EmailNotifyOnMessageReceived","MessageNotifyOnArticleLiked","MessageNotifyOnArticleReplied","MessageNotifyOnCommentLiked","MessageNotifyOnCommentReplied","MessageNotifyOnEditorRecommended"]}return t.some(function(e){return g(e)})},e.optionsInPageError=function(t){var n=[];switch(t){case"profiles":n=["vm.GamerTag","vm.Email"];break;case"platform":break;case"security":n=["vm.Password","vm.NewPassword","vm.ConfirmPassword","authCode"];break;case"preferences":}return n.some(function(t){return e.error[t]})};var k=function(){var t=["profiles","platform","security","preferences"];for(var n in t)if(t.hasOwnProperty(n)&&e.optionsInPageError(t[n])){e.page=t[n];break}};e.submitLock=!1,e.submit=function(){if(!e.submitLock){if(e.submitLock=!0,e.error={},n.modelValidate.gamerTag(e.vm.GamerTag,e.error,"vm.GamerTag"),(g("NewPassword")||g("LockoutEnabled"))&&(e.vm.Password||(e.error["vm.Password"]="Password cannot be empty."),v||(e.error.authCode=!0),e.vm.NewPassword&&n.modelValidate.password(e.vm.NewPassword,e.error,"vm.NewPassword")&&e.vm.NewPassword!==e.vm.ConfirmPassword&&(e.error["vm.ConfirmPassword"]="not match")),g("Email")&&(form.email.$invalid?e.error["vm.Email"]="Email is invalid.":e.vm.Email||(e.error["vm.Email"]="Email cannot be empty.")),!$.isEmptyObject(e.error))return k(),void(e.submitLock=!1);var a={};for(var c in e.vm)e.vm.hasOwnProperty(c)&&g(c)&&(a[c]=e.vm[c]);if(!e.files.avatarImage&&!e.files.profilePointBackgroundImage&&$.isEmptyObject(a))return s.success("个人设定已更新"),void t();var u=function(){o.put(r+"user/"+i.$localStorage.login.UserId,a).then(function(){$.extend(i.$localStorage.user,a),s.success("个人设定已更新"),t()},function(t){switch(t.status){case 400:e.error=t.data.ModelState,v=null,y.refresh().then(C),k();break;default:s.error("未知错误",t)}e.submitLock=!1})};if(e.files.avatarImage||e.files.profilePointBackgroundImage){s.process("图像正在上传");var d=m.policy();m.signature(d).then(function(t){var n={};e.files.avatarImage&&(n.avatarImage=m.upload(e.files.avatarImage,d,t),n.avatarImage.then(function(e){a.AvatarImage="keylol://"+e.data.url},function(){s.error("头像上传失败"),e.submitLock=!1})),e.files.profilePointBackgroundImage&&(n.profilePointBackgroundImage=m.upload(e.files.profilePointBackgroundImage,d,t),n.profilePointBackgroundImage.then(function(e){a.ProfilePointBackgroundImage="keylol://"+e.data.url},function(){s.error("个人据点横幅上传失败"),e.submitLock=!1})),l.all(n).then(function(){u()})},function(){s.error("文件上传验证失效"),e.submitLock=!1})}else u()}},e.logout=function(){s.attention("从当前账户登出",[{action:"登出",value:!0},{action:"取消"}]).then(function(e){e&&o["delete"](r+"login/current").then(function(){delete i.$localStorage.login,s.success("已登出当前账户"),t()},function(e){s.error("未知错误",e)})})}}])}(),function(){"use strict";keylolApp.controller("ShopLinkController",["$scope","close","$http","apiEndpoint","utils","notification","window",function(e,t,n,o,i,r,a){function c(e){var t=e.match(/^(?:(?:https?:\/\/)?store\.steampowered\.com\/app\/)?(\d+)\/*$/i);return t?parseInt(t[1]):!1}e.vm={},e.submitLock=!1,e.currentStation=0,e.cancel=function(){t()},e.shopLinkError=!1,e.submit=function(){if(!e.submitLock){e.submitLock=!0;var i=c(e.vm.shopLink);i?(r.process("正在抓取商店信息，可能需要几秒的时间"),e.currentStation=1,n.post(o+"normal-point/from-app-id",{},{params:{appId:i}}).then(function(n){var o=n.data;e.submitLock=!1,a.show({templateUrl:"components/windows/confirmation.html",controller:"ConfirmationController",inputs:{point:o}}),t()},function(t){r.error("未知错误",t),e.submitLock=!1})):(e.shopLinkError=!0,e.submitLock=!1)}}}])}(),function(){"use strict";keylolApp.controller("ShortReviewController",["$scope","close","window","notification","$http","options","$location","$route","union",function(e,t,n,o,i,r,a,c,l){e.options=r,e.vm=$.extend({TypeName:"简评",Title:r.point.Name+" 的简评",Content:"",Vote:null,VoteForPointId:r.point.Id},r.vm),e.count=e.vm.Content.length,e.cancel=function(){t()},e.changeToLong=function(){o.attention("切换为长评时会覆盖之前未发布的草稿",[{action:"覆盖",value:!0},{action:"取消"}]).then(function(o){o&&(n.show({templateUrl:"components/windows/editor.html",controller:"EditorController",inputs:{options:{doNotLoadDraft:!0,vm:{Id:e.vm.Id,TypeName:"评",Title:e.vm.Title,Content:e.vm.Content,Vote:e.vm.Vote,Summary:"",Pros:[],Cons:[]},voteForPoint:r.point}}}),t())})},e.submitLock=!1;var s=function(){return e.vm.Content?e.vm.Vote?null:"简评评分":"简评内容"};e.submit=function(){if(!(e.submitLock||e.vm.Content.length>199)){var n=s();if(n)return o.error(n+"不能为空");e.submitLock=!0,e.vm.Id?i.put(apiEndpoint+"article/"+e.vm.Id,e.vm).then(function(e){t(),c.reload(),o.success("简评已发布")},function(t){o.error("未知错误, 请尝试再次发布",t),e.submitLock=!1}):i.post(apiEndpoint+"article",e.vm).then(function(e){t(),a.url("article/"+l.$localStorage.user.IdCode+"/"+e.data.SequenceNumberForAuthor),o.success("简评已发布")},function(t){o.error("未知错误, 请尝试再次发布",t),e.submitLock=!1})}}}])}(),function(){"use strict";keylolApp.controller("SteamConnectController",["$scope","close","$timeout","$q","notification","utils",function(e,t,n,o,i,r){var a,c,l=!1,s=$.connection["new"](),u=s.steamBindingHub;e.utils=r,e.currentStation=0,e.cancel=function(){t(c),l=!0,c||s.stop()},u.client.NotifySteamFriendAdded=function(){e.$apply(function(){0===e.currentStation&&(e.currentStation=1)})},u.client.NotifyCodeReceived=function(i,r){e.$apply(function(){e.currentStation=2;var u=o.defer();u.promise["finally"](function(){s.stop()}),"0000000000000000000000000000000000000000"===r&&(r="fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb"),c={tokenId:a,steamProfileName:i,steamAvatarHash:r,consume:u},n(function(){e.currentStation=3,n(function(){l||(t(c),l=!0)},1500)},200)})},s.start().then(function(){u.server.createToken().then(function(t){e.$apply(function(){t?(a=t.Id,e.botSteamId64=t.BotSteamId64,e.code=t.Code):(i.error("暂无可用机器人。"),e.cancel())})})},function(){i.error("连接失败。"),e.cancel()})}])}();